<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Gestion Produits</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { margin:0; font-family:sans-serif; background:#f5f7fa; color:#333; display:flex; flex-direction:column; align-items:center; }
h2{text-align:center; margin:15px 0;}
.inputs-container {width:95%; display:flex; flex-wrap:wrap; gap:10px; margin-bottom:10px;}
input, button {padding:10px; font-size:16px; border-radius:8px; border:1px solid #ccc; flex:1 1 45%;}
input:focus {border-color:#3498db; outline:none;}
button {border:none; color:#fff; font-weight:bold; cursor:pointer;}
#addButton {background:#3498db;} #addButton:hover {background:#2980b9;}
#downloadBtn {background:#2ecc71;} #downloadBtn:hover {background:#27ae60;}
#productCount{font-weight:600;margin:10px 0;width:95%;}
.cards-container{width:95%;display:flex;flex-direction:column;gap:10px;margin-bottom:20px;}
.card{background:#fff;padding:8px 12px;border-radius:10px;box-shadow:0 3px 8px rgba(0,0,0,0.1);display:flex;flex-direction:column;gap:4px;}
.card-row-flex{display:flex;justify-content:space-between;align-items:center;}
.card-row-name{display:block;font-weight:bold;font-size:16px;}
.card-footer{display:flex;justify-content:flex-end;}
.days-left{padding:2px 6px;border-radius:6px;color:#fff;font-size:14px;}
.card-footer button{background:#e74c3c;color:#fff;padding:4px 10px;border-radius:6px;font-size:14px;cursor:pointer;}
.card-footer button:hover{background:#c0392b;}
@media(max-width:500px){input,button{flex:1 1 100%;}.card-row-flex{flex-direction:column;align-items:flex-start;gap:2px;}}
</style>
</head>
<body>

<h2>Gestion Produits</h2>

<div class="inputs-container">
  <input id="codeInput" placeholder="Code produit">
  <input id="nameOutput" placeholder="Nom produit" readonly>
  <input id="expiryInput" type="text" placeholder="Date (DD/MM/YYYY)" maxlength="10" inputmode="numeric">
  <input id="quantityInput" type="number" placeholder="Quantité">
  <button id="addButton">Ajouter</button>
  <button id="downloadBtn">Télécharger CSV</button>
</div>

<p id="productCount">Nombre de produits: 0</p>
<div class="cards-container" id="cardsContainer"></div>

<script>
let products = JSON.parse(localStorage.getItem("products")) || [];

// auto-slash للتاريخ
const expiryInput = document.getElementById("expiryInput");
expiryInput.addEventListener("input", function(){
  let val=this.value.replace(/[^0-9]/g,'');
  if(val.length>2 && val.length<=4) val=val.slice(0,2)+'/'+val.slice(2);
  else if(val.length>4) val=val.slice(0,2)+'/'+val.slice(2,4)+'/'+val.slice(4,8);
  this.value=val.slice(0,10);
});

function formatDateInput(input){let parts=input.split('/'); if(parts.length!==3) return null; return parts.map(p=>p.padStart(2,'0')).join('/');}
function isValidDate(dateStr){const [d,m,y]=dateStr.split("/").map(Number); const date=new Date(y,m-1,d); return date.getFullYear()===y && date.getMonth()===m-1 && date.getDate()===d;}
function daysLeft(expiry){const [d,m,y]=expiry.split("/").map(Number); const expiryDate=new Date(y,m-1,d); const today=new Date(); const diffTime=expiryDate-today; return Math.ceil(diffTime/(1000*60*60*24));}
function daysColor(days){if(days<0) return "#7f8c8d"; if(days<=3) return "#e74c3c"; if(days<=7) return "#f39c12"; return "#2ecc71";}

// إضافة منتوج
document.getElementById("addButton").addEventListener("click", function(){
  const code=document.getElementById("codeInput").value.trim();
  const name=document.getElementById("nameOutput").value;
  let expiry=document.getElementById("expiryInput").value.trim();
  const quantity=document.getElementById("quantityInput").value;
  expiry=formatDateInput(expiry);
  if(!expiry||!isValidDate(expiry)){alert("Date invalide!"); return;}
  if(!code||!quantity){alert("Remplissez tous les champs!"); return;}
  products.push({code,name,expiry,quantity});
  localStorage.setItem("products",JSON.stringify(products));
  document.getElementById("codeInput").value="";
  document.getElementById("nameOutput").value="";
  document.getElementById("expiryInput").value="";
  document.getElementById("quantityInput").value="";
  renderCards();
});

// عرض المنتجات
function renderCards(){
  const container=document.getElementById("cardsContainer");
  container.innerHTML="";
  products.forEach((p,index)=>{
    const remaining=daysLeft(p.expiry);
    const color=daysColor(remaining);
    const card=document.createElement("div");
    card.className="card";
    card.innerHTML=`
      <div class="card-row-flex">
        <span>${p.code}</span>
        <span class="days-left" style="background:${color}">${remaining} jour(s)</span>
      </div>
      <div class="card-row-name">${p.name}</div>
      <div class="card-row-flex">
        <span>Quantité: ${p.quantity}</span>
        <span>Date: ${p.expiry}</span>
      </div>
      <div class="card-footer">
        <button onclick="deleteProduct(${index})">Supprimer</button>
      </div>
    `;
    container.appendChild(card);
  });
  document.getElementById("productCount").textContent=`Nombre de produits: ${products.length}`;
}

function deleteProduct(index){if(!confirm("Voulez-vous vraiment supprimer ce produit ?")) return; products.splice(index,1); localStorage.setItem("products",JSON.stringify(products)); renderCards();}

// Download CSV via Netlify function
document.getElementById("downloadBtn").addEventListener("click", function(){
  if(products.length===0){alert("Aucun produit à télécharger!"); return;}
  let csvContent="Code,Nom,Date,Quantité\n";
  products.forEach(p=>{csvContent+=`${p.code},${p.name},${p.expiry},${p.quantity}\n`;});
  
  const fileName="produits.csv";
  // Fetch Netlify function
  fetch(`https://YOUR_NETLIFY_SITE.netlify.app/.netlify/functions/export?csv=${encodeURIComponent(csvContent)}`)
  .then(r=>r.blob())
  .then(blob=>{
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url; a.download=fileName; a.click();
  })
  .catch(err=>alert("Erreur téléchargement: "+err));
});

renderCards();
</script>

</body>
</html>