<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>SUIVI DLC PRO</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<!-- OneSignal SDK -->
<script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
<script>
  window.OneSignalDeferred = window.OneSignalDeferred || [];
  OneSignalDeferred.push(async function(OneSignal) {
    await OneSignal.init({
      appId: "21c46004-5baa-48c7-bdea-2cb7beb12b4a",
    });
  });
</script>
<style>
/* CSS Ù…Ø­Ø³Ù† Ù„Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙƒØ§Ù…Ù„ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ø§Ø´Ø§Øª */
* {
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
    -webkit-touch-callout: none;
    -webkit-tap-highlight-color: transparent;
}

body {
    margin:0; 
    padding: 0;
    font-family: 'Playfair Display', serif;
    background:#f5f7fa; 
    color:#333; 
    display:flex; 
    flex-direction:column; 
    align-items:center;
    min-height: 100vh;
    box-sizing: border-box;
    width: 100%;
    overflow-x: hidden;
    touch-action: pan-x pan-y;
}
h2 { 
    text-align:center; 
    margin:15px 0; 
    color:#1a237e; 
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    text-transform: uppercase;
    width: 100%;
    box-sizing: border-box;
    padding: 0 10px;
    font-weight: bold;
}

/* ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 1: Ø¥Ø·Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„Ø±Ø§ÙŠÙˆÙ† Ø¨Ø­Ø¬Ù… Ø£ØµÙØ± ==== */
.user-inputs-container {
    width: 95%;
    max-width: 600px;
    display: flex;
    flex-direction: row;
    gap: 10px;
    margin-bottom: 15px;
    box-sizing: border-box;
}

.user-input-group {
    display: flex;
    flex-direction: column;
    flex: 1;
}

.user-input-group input, .user-input-group select {
    padding: 8px; /* ØªÙ… ØªØµØºÙŠØ± Ø§Ù„Ø­Ø´ÙˆØ© */
    font-size: 14px; /* ØªÙ… ØªØµØºÙŠØ± Ø§Ù„Ø®Ø· */
    border-radius: 6px;
    border: 2px solid #1a237e;
    font-family: 'Playfair Display', serif;
    box-sizing: border-box;
    font-weight: bold;
    text-align: center;
    width: 100%;
    height: 40px; /* Ø§Ø±ØªÙØ§Ø¹ Ø«Ø§Ø¨Øª */
}

.user-input-group input:focus, .user-input-group select:focus {
    border-color: #3498db;
    outline: none;
}

/* ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø­Ù‚Ù„ Ø¥Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ ÙƒÙ… textarea ==== */
.product-name-textarea {
    width: 100%;
    text-align: center;
    border: 2px solid #1a237e !important;
    background: white !important;
    color: #000000;
    font-size: 16px;
    font-weight: bold;
    padding: 10px;
    line-height: 1.3;
    min-height: 60px;
    height: 60px;
    max-height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    word-break: break-word;
    overflow: hidden;
    resize: none;
    border-radius: 6px;
    font-family: 'Playfair Display', serif;
    box-sizing: border-box;
}

/* ==== Ù†Ø§ÙØ°Ø© Ø§Ù„Ø­ÙˆØ§Ø± Ø§Ù„Ù…Ø®ØµØµØ© ==== */
.custom-confirm-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    z-index: 10001;
    justify-content: center;
    align-items: center;
}

.confirm-dialog {
    background: white;
    padding: 25px;
    border-radius: 15px;
    width: 90%;
    max-width: 400px;
    text-align: center;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    animation: fadeInScale 0.3s ease;
}

@keyframes fadeInScale {
    from { opacity: 0; transform: scale(0.8); }
    to { opacity: 1; transform: scale(1); }
}

.confirm-title {
    font-size: 20px;
    font-weight: bold;
    color: #e74c3c;
    margin-bottom: 15px;
    text-transform: uppercase;
}

.confirm-message {
    font-size: 16px;
    margin-bottom: 25px;
    color: #333;
    line-height: 1.5;
}

.confirm-buttons {
    display: flex;
    gap: 15px;
    justify-content: center;
}

.confirm-btn {
    padding: 12px 25px;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    min-width: 120px;
    text-transform: uppercase;
}

.confirm-cancel {
    background: linear-gradient(145deg, #95a5a6, #7f8c8d);
    color: white;
}

.confirm-cancel:hover {
    background: linear-gradient(145deg, #7f8c8d, #6c7b7d);
    transform: translateY(-2px);
}

.confirm-ok {
    background: linear-gradient(145deg, #3498db, #2980b9);
    color: white;
}

.confirm-ok:hover {
    background: linear-gradient(145deg, #2980b9, #2471a3);
    transform: translateY(-2px);
}

.alert-ok {
    background: linear-gradient(145deg, #2ecc71, #27ae60);
    color: white;
}

.alert-ok:hover {
    background: linear-gradient(145deg, #27ae60, #219653);
    transform: translateY(-2px);
}

/* ==== Ù†Ø§ÙØ°Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ§Ù„Ù…Ø´Ø§Ø±ÙƒØ© ==== */
.download-share-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    z-index: 10002;
    justify-content: center;
    align-items: center;
}

.download-share-content {
    background: white;
    padding: 25px;
    border-radius: 15px;
    width: 90%;
    max-width: 400px;
    text-align: center;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    animation: fadeInScale 0.3s ease;
}

.download-share-title {
    font-size: 20px;
    font-weight: bold;
    color: #1a237e;
    margin-bottom: 15px;
    text-transform: uppercase;
}

.download-share-options {
    display: flex;
    flex-direction: column;
    gap: 15px;
    margin-bottom: 25px;
}

.download-share-option {
    padding: 15px;
    border: 2px solid #1a237e;
    border-radius: 8px;
    background: #f8f9fa;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: bold;
}

.download-share-option:hover {
    background: #e9ecef;
    transform: translateY(-2px);
}

.download-share-option.selected {
    background: #1a237e;
    color: white;
}

.month-selection, .day-selection {
    display: none;
    margin-top: 15px;
}

.month-selection select, .day-selection select {
    width: 100%;
    padding: 10px;
    border: 2px solid #1a237e;
    border-radius: 6px;
    font-size: 14px;
}

/* ==== Ù†Ø§ÙØ°Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ù„ØµÙØ­Ø© Ø§Ù„Ø¨Ø­Ø« ==== */
.download-share-modal-search {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    z-index: 10003;
    justify-content: center;
    align-items: center;
}

.download-share-content-search {
    background: white;
    padding: 25px;
    border-radius: 15px;
    width: 90%;
    max-width: 400px;
    text-align: center;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    animation: fadeInScale 0.3s ease;
}

.download-share-title-search {
    font-size: 20px;
    font-weight: bold;
    color: #1a237e;
    margin-bottom: 15px;
    text-transform: uppercase;
}

.download-share-options-search {
    display: flex;
    flex-direction: column;
    gap: 15px;
    margin-bottom: 25px;
}

.download-share-option-search {
    padding: 15px;
    border: 2px solid #1a237e;
    border-radius: 8px;
    background: #f8f9fa;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: bold;
}

.download-share-option-search:hover {
    background: #e9ecef;
    transform: translateY(-2px);
}

.download-share-option-search.selected {
    background: #1a237e;
    color: white;
}

/* ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 3: Ø²Ø± SCANNER Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ ==== */
#scanButton, #casseFraisScanButton {
    width: 180px !important;
    max-width: 180px !important;
    min-width: 180px !important;
    margin-top: 0;
    border: none !important;
    background: linear-gradient(145deg, #e67e22, #d35400) !important;
    color: white !important;
    font-weight: bold;
}

#scanButton:hover, #casseFraisScanButton:hover {
    background: linear-gradient(145deg, #d35400, #e67e22) !important;
    transform: translateY(-2px);
}

/* ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 3: Ø£Ø²Ø±Ø§Ø± Ø¨Ø£Ù„ÙˆØ§Ù† Ø¥Ø­ØªØ±Ø§ÙÙŠØ© Ù…Ø¹ Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª 3D ==== */
/* Ø²Ø± AJOUTER Ø¨Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø®Ø¶Ø± */
#addButton, #casseFraisAddButton { 
    background: linear-gradient(145deg, #2ecc71, #27ae60) !important;
    box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3);
} 
#addButton:hover, #casseFraisAddButton:hover { 
    background: linear-gradient(145deg, #27ae60, #219653) !important;
    transform: translateY(-2px);
}

/* Ø²Ø± IMPORT Ø¨Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø¨Ù†ÙØ³Ø¬ÙŠ */
#importButton { 
    background: linear-gradient(145deg, #9b59b6, #8e44ad) !important;
    box-shadow: 0 4px 15px rgba(155, 89, 182, 0.3);
} 
#importButton:hover { 
    background: linear-gradient(145deg, #8e44ad, #7d3c98) !important;
    transform: translateY(-2px);
}

/* Ø²Ø± TELECHARGER Ø¨Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø²Ø±Ù‚ */
#downloadXLSX, #casseFraisDownloadXLSX { 
    background: linear-gradient(145deg, #3498db, #2980b9) !important;
    box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
} 
#downloadXLSX:hover, #casseFraisDownloadXLSX:hover { 
    background: linear-gradient(145deg, #2980b9, #2471a3) !important;
    transform: translateY(-2px);
}

/* Ø²Ø± PARTAGER Ø¨Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£ØµÙØ± */
#shareButton, #casseFraisShareButton { 
    background: linear-gradient(145deg, #f1c40f, #f39c12) !important;
    box-shadow: 0 4px 15px rgba(241, 196, 15, 0.3);
} 
#shareButton:hover, #casseFraisShareButton:hover { 
    background: linear-gradient(145deg, #f39c12, #e67e22) !important;
    transform: translateY(-2px);
}

/* Ø²Ø± RECHERCHE Ø¨Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø®Ø¶Ø± Ø§Ù„Ù…Ø²Ø±Ù‚ */
#searchButton {
    background: linear-gradient(145deg, #1abc9c, #16a085) !important;
    box-shadow: 0 4px 15px rgba(26, 188, 156, 0.3);
}
#searchButton:hover {
    background: linear-gradient(145deg, #16a085, #138a72) !important;
    transform: translateY(-2px);
}

/* Ø²Ø± CASSE FRAIS Ø¨Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø­Ù…Ø± */
#casseFraisButton {
    background: linear-gradient(145deg, #e74c3c, #c0392b) !important;
    box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
}
#casseFraisButton:hover {
    background: linear-gradient(145deg, #c0392b, #a93226) !important;
    transform: translateY(-2px);
}

/* ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 2: ØªØ­Ø³ÙŠÙ† Ø¥Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ù„Ø³Ø·Ø±ÙŠÙ† ==== */
.card-name {
    font-size: 16px !important;
    font-weight: 700;
    text-transform: uppercase;
    word-break: break-word;
    margin-bottom: 4px;
    color: #000000;
    letter-spacing: 0.5px;
    text-align: center;
    line-height: 1.3;
    min-height: 2.8em;
    max-height: 3.6em;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 4px 8px;
    overflow-y: auto;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
}

/* ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 5: ØªØºÙŠÙŠØ± Ù„ÙˆÙ† NOMBRE DES PRODUITS ==== */
#productCount, #casseFraisProductCount { 
    margin: 10px 0 !important; /* ØªÙ… Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø³Ø§ÙØ© */
    width: auto !important;
    max-width: none !important;
    text-align: center;
    padding: 8px 16px !important;
    background: #1a237e !important; /* Ø®Ù„ÙÙŠØ© Ø²Ø±Ù‚Ø§Ø¡ */
    color: #ffeb3b !important; /* Ù„ÙˆÙ† Ø§Ù„Ù†Øµ Ø£ØµÙØ± */
    border-radius: 6px !important;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
    text-transform: uppercase;
    font-weight: bold;
    box-sizing: border-box;
    border: none !important;
    font-size: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    white-space: nowrap;
}

/* ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 4: Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø£Ø¹Ù„Ù‰ ==== */
.scroll-to-top {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: linear-gradient(145deg, #1a237e, #0d1459);
    color: white;
    border: none;
    font-size: 24px;
    cursor: pointer;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    display: none;
    z-index: 1000;
    transition: all 0.3s ease;
}

.scroll-to-top:hover {
    background: linear-gradient(145deg, #0d1459, #1a237e);
    transform: scale(1.1);
}

/* ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 4: Ø¯Ø§Ø¦Ø±Ø© ØµÙØ±Ø§Ø¡ Ø¨Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø­Ù…Ø± ==== */
.month-count {
    background: #ffeb3b;
    color: #e74c3c !important;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 14px;
    margin-left: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

/* ==== Ù†Ø§ÙØ°Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© ==== */
.product-history-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    z-index: 10002;
    justify-content: center;
    align-items: center;
}

.product-history-content {
    background: white;
    padding: 20px;
    border-radius: 15px;
    width: 90%;
    max-width: 500px;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    animation: fadeInScale 0.3s ease;
}

.product-history-title {
    font-size: 20px;
    font-weight: bold;
    color: #1a237e;
    margin-bottom: 15px;
    text-align: center;
    text-transform: uppercase;
}

.product-history-list {
    margin: 15px 0;
}

.product-history-item {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    padding: 12px;
    border-radius: 10px;
    margin-bottom: 10px;
    border-left: 4px solid #3498db;
}

.product-history-details {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 5px;
}

.product-history-date {
    font-weight: bold;
    color: #e74c3c;
}

.product-history-quantity {
    font-weight: bold;
    color: #27ae60;
}

.product-history-days {
    font-size: 12px;
    color: #7f8c8d;
    text-align: center;
}

/* ==== Ø²Ø± SUPPRIMER TOUT ==== */
.delete-all-container {
    display: flex;
    justify-content: center;
    margin: 10px 0 20px 0;
    width: 95%;
    max-width: 600px;
}

#deleteAllButton, #casseFraisDeleteAllButton {
    background: linear-gradient(145deg, #e74c3c, #c0392b);
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    transition: transform 0.2s ease;
    text-transform: uppercase;
    width: 100%;
    max-width: 300px;
}

#deleteAllButton:hover, #casseFraisDeleteAllButton:hover {
    background: linear-gradient(145deg, #c0392b, #a93226);
    transform: scale(1.05);
}

/* Ø¨Ø§Ù‚ÙŠ Ø§Ù„CSS */
.inputs-container { 
    width:95%; 
    max-width: 600px;
    display:flex; 
    flex-wrap:wrap; 
    gap:8px; 
    margin-bottom:10px; 
    box-sizing: border-box;
}
.input-group {
    display: flex;
    flex-direction: column;
    flex: 1 1 100%;
    box-sizing: border-box;
    width: 100%;
}
input, button, select { 
    padding:8px; 
    font-size:14px; 
    border-radius:6px; 
    border:2px solid #1a237e;
    font-family:'Playfair Display', serif;
    box-sizing: border-box;
    font-weight: bold;
}
input:focus, select:focus { border-color:#3498db; outline:none; }
button { border:none; color:#fff; cursor:pointer; }

/* ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 2: ØªØ­Ø³ÙŠÙ† Ø¥Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ù„Ø³Ø·Ø±ÙŠÙ† ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ ÙˆØ§Ù„Ø«Ø§Ù„Ø«Ø© ==== */
#nameOutput, #casseFraisNameOutput {
    width: 100%;
    text-align: center;
    border: none !important;
    background: transparent !important;
    color: #000000;
    font-size: 16px;
    font-weight: bold;
    padding: 10px 0;
    line-height: 1.3;
    min-height: 2.6em;
    display: flex;
    align-items: center;
    justify-content: center;
    word-break: break-word;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
}

.date-quantity-container {
    display: flex;
    flex-direction: row;
    gap: 8px;
    width: 100%;
    box-sizing: border-box;
    justify-content: center;
}

#expiryInput, #quantityInput, #codeInput, 
#casseFraisExpiryInput, #casseFraisQuantityInput, #casseFraisCodeInput {
    width: 180px !important;
    max-width: 180px !important;
    min-width: 180px !important;
    flex: 0 0 auto !important;
    text-align: center;
    font-weight: bold;
    letter-spacing: 1px;
    border: 2px solid #1a237e;
}

.code-scan-container {
    display: flex;
    flex-direction: row;
    gap: 8px;
    width: 100%;
    box-sizing: border-box;
    justify-content: center;
    align-items: center;
}

.image-container {
    display: flex;
    flex-direction: row;
    align-items: center;
    justify-content: center;
    width: 100%;
    gap: 15px;
    margin-top: 15px;
}

.camera-icon, .stock-icon {
    background:#3498db; 
    font-size:16px; 
    padding:6px; 
    border-radius:6px; 
    color:#fff; 
    cursor:pointer; 
    width: 36px;
    height: 36px;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-shrink: 0;
}

#previewImage {
    width: 60px;
    height: 60px;
    object-fit: cover;
    border: none !important;
    border-radius: 6px;
    flex-shrink: 0;
    margin: 0 10px;
    background: transparent;
}

/* ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 3: Ø¥Ø¹Ø§Ø¯Ø© ØªÙ†Ø¸ÙŠÙ… Ø§Ù„Ø£Ø²Ø±Ø§Ø± ==== */
.buttons-container {
    display: flex;
    flex-direction: column;
    gap: 10px;
    width: 100%;
    box-sizing: border-box;
    margin-top: 15px;
}

.button-row {
    display: flex;
    gap: 8px;
    width: 100%;
    box-sizing: border-box;
}

.button-row button {
    flex: 1;
    padding: 10px 6px;
    font-size: 13px;
    border-radius: 6px;
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    min-height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    line-height: 1.2;
    gap: 8px;
}

/* ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 3: Ø²Ø±ÙŠÙ† RECHERCHE Ùˆ CASSE FRAIS Ø¨Ø­Ø¬Ù… Ù…Ù†Ø§Ø³Ø¨ ==== */
#searchButton, #casseFraisButton {
    background: linear-gradient(145deg, #3498db, #2980b9);
    flex: 1;
    padding: 10px 6px;
    font-size: 13px;
    border-radius: 6px;
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    min-height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    line-height: 1.2;
    gap: 8px;
}

#searchButton:hover, #casseFraisButton:hover {
    background: linear-gradient(145deg, #2980b9, #2471a3);
}

.cards-container { 
    width:95%; 
    max-width: 600px;
    display:flex; 
    flex-direction:column; 
    gap:10px; 
    margin-bottom:20px; 
    box-sizing: border-box;
}

.card { 
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%); 
    padding:12px;
    border-radius:12px; 
    box-shadow:0 4px 15px rgba(0,0,0,0.1); 
    display:flex; 
    flex-direction:row; 
    gap:12px; 
    align-items:flex-start; 
    position:relative; 
    opacity:0; 
    transform:translateY(12px); 
    animation: fadeSlide 0.35s ease forwards; 
    box-sizing: border-box;
    width: 100%;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.15);
}
@keyframes fadeSlide { to { opacity:1; transform:translateY(0); } }

.card-image-container {
    width: 80px;
    height: 80px;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid #1a237e;
    border-radius: 10px;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    position: relative;
    overflow: hidden;
    cursor: pointer;
}

.card-image-container img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 8px;
}

.card-image-container .edit-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 12px;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.card-image-container:hover .edit-overlay {
    opacity: 1;
}

.card-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 8px;
    min-width: 0;
}

.card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 2px;
}

.days-left {
    padding: 6px 10px;
    border-radius: 8px;
    color: #fff;
    font-size: 12px;
    font-weight: bold;
    white-space: nowrap;
    margin-right: auto;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
}

.card-code {
    font-size: 14px;
    font-weight: bold;
    color: #2c3e50;
    margin-top: 4px;
    padding: 4px 8px;
    background: linear-gradient(135deg, #ecf0f1 0%, #bdc3c7 100%);
    border-radius: 6px;
    display: inline-block;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    /* ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 1: Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯ ÙÙ‚Ø· ==== */
    -webkit-user-select: text;
    -moz-user-select: text;
    -ms-user-select: text;
    user-select: text;
    cursor: text;
}

.card-details {
    display: flex;
    gap: 15px;
    font-size: 13px;
    color: #2c3e50;
    margin-top: 4px;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    padding: 8px 12px;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
}

.card-date, .card-quantity {
    cursor: pointer;
    transition: background-color 0.3s ease;
    position: relative;
}

.card-date:hover, .card-quantity:hover {
    background: rgba(0,0,0,0.1);
}

.card-date {
    font-weight: 600;
    color: #e74c3c;
    padding: 2px 6px;
    background: rgba(231, 76, 60, 0.1);
    border-radius: 4px;
}

.card-quantity {
    font-weight: 600;
    color: #27ae60;
    padding: 2px 6px;
    background: rgba(39, 174, 96, 0.1);
    border-radius: 4px;
}

.card-footer { 
    position: absolute; 
    top: 8px; 
    right: 8px; 
    z-index: 999; 
    display: flex;
    gap: 5px;
}
.card-footer button { 
    width:28px; 
    height:28px; 
    border-radius:50%; 
    font-size:16px; 
    padding:0; 
    display:flex; 
    justify-content:center; 
    align-items:center; 
    cursor:pointer; 
    border: none;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    transition: transform 0.2s ease;
}
.card-footer .delete-btn { 
    background: linear-gradient(145deg, #e74c3c, #c0392b); 
}
.card-footer .edit-btn { 
    background: linear-gradient(145deg, #3498db, #2980b9); 
}
.card-footer button:hover { 
    transform: scale(1.1);
}

.card-footer .delete-btn:hover { 
    background: linear-gradient(145deg, #c0392b, #a93226); 
}
.card-footer .edit-btn:hover { 
    background: linear-gradient(145deg, #2980b9, #2471a3); 
}

.storage-info {
    background: linear-gradient(145deg, #3498db, #2980b9);
    color: white;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 12px;
    margin: 5px 0 15px 0;
    text-align: center;
    width: 95%;
    max-width: 600px;
    box-sizing: border-box;
    order: -1;
}

/* ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 4: Ø²Ø± Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ø§Ù„Ù‚Ø³Ù… - Ø¹Ø±Ø¶ Ø«Ø§Ø¨Øª ==== */
.section-delete-btn {
    background: linear-gradient(145deg, #e74c3c, #c0392b);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: bold;
    cursor: pointer;
    margin-left: 10px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    transition: transform 0.2s ease;
    white-space: nowrap;
    width: 120px;
    flex-shrink: 0;
}

.section-delete-btn:hover {
    background: linear-gradient(145deg, #c0392b, #a93226);
    transform: scale(1.05);
}

/* ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 4: ØªØ­Ø³ÙŠÙ† Ø¹Ø±Ø¶ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ù…Ø¹ Ø²Ø± SUPPRIMER ÙÙŠ Ù†ÙØ³ Ø§Ù„Ø³Ø·Ø± ==== */
.month-section {
    margin: 8px 0 3px 0;
    padding: 10px 15px;
    border-radius: 10px;
    font-weight: bold;
    color: white;
    text-align: center;
    text-transform: uppercase;
    width: 100%;
    box-sizing: border-box;
    box-shadow: 0 3px 10px rgba(0,0,0,0.2);
    letter-spacing: 1px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: nowrap;
}

.expired-section {
    background: linear-gradient(145deg, #e74c3c, #c0392b);
    border: none;
}

.future-section {
    background: linear-gradient(145deg, #1a237e, #0d1459);
    border: none;
    color: white;
}

/* ==== Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ==== */
#cameraOverlay { 
    display:none; 
    position:fixed; 
    top:0; 
    left:0; 
    width:100vw; 
    height:100vh; 
    background:rgba(0,0,0,0.85); 
    z-index:9999; 
    justify-content:center; 
    align-items:center; 
    flex-direction:column; 
}
#cameraOverlay video { 
    width:100%; 
    height:100%; 
    object-fit:cover; 
}

.camera-controls {
    position: absolute;
    bottom: 30px;
    left: 0;
    width: 100%;
    display: flex;
    justify-content: center;
    gap: 20px;
    z-index: 10000;
}

#captureButton, #closeCameraButton {
    width: 140px !important;
    min-width: 140px !important;
    padding: 12px 20px !important;
    font-size: 16px !important;
    margin: 0 !important;
    border-radius: 8px;
    font-weight: bold;
    text-transform: uppercase;
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
}

#captureButton { 
    background: linear-gradient(145deg, #2ecc71, #27ae60); 
}
#captureButton:hover { 
    background: linear-gradient(145deg, #27ae60, #219653); 
}

#closeCameraButton { 
    background: linear-gradient(145deg, #e74c3c, #c0392b); 
}
#closeCameraButton:hover { 
    background: linear-gradient(145deg, #c0392b, #a93226); 
}

/* ==== Ø§Ù„Ù…Ø§Ø³Ø­ Ø§Ù„Ø¶ÙˆØ¦ÙŠ ==== */
.scanner-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    z-index: 9999;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

.scanner-frame {
    width: 90%;
    max-width: 400px;
    height: 300px;
    border: 2px solid #fff;
    border-radius: 10px;
    position: relative;
    overflow: hidden;
    box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.5);
}

.scanner-frame::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, transparent, #3498db, transparent);
    animation: scanLine 2s linear infinite;
}

@keyframes scanLine {
    0% { top: 0; }
    100% { top: 100%; }
}

.scanner-controls {
    margin-top: 20px;
    display: flex;
    gap: 10px;
}

.scanner-controls button {
    padding: 10px 20px;
    border-radius: 6px;
    border: none;
    color: white;
    font-weight: bold;
    cursor: pointer;
}

#closeScanner, #casseFraisCloseScanner {
    background: #e74c3c;
}

#toggleTorch, #casseFraisToggleTorch {
    background: #3498db;
}

.loading-spinner {
    display: none;
    width: 40px;
    height: 40px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 10px auto;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.success-message {
    display: none;
    background: #2ecc71;
    color: white;
    padding: 10px;
    border-radius: 6px;
    margin: 10px 0;
    text-align: center;
    animation: fadeInOut 3s ease;
}

@keyframes fadeInOut {
    0%, 100% { opacity: 0; }
    20%, 80% { opacity: 1; }
}

/* ==== ØµÙØ­Ø© Ø§Ù„Ø¨Ø­Ø« ==== */
.search-page {
    display: none;
    width: 95%;
    max-width: 600px;
    flex-direction: column;
    align-items: center;
}

.search-inputs {
    display: flex;
    flex-direction: column;
    gap: 15px;
    margin: 20px 0;
    width: 100%;
}

.search-input-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
    width: 100%;
}

.search-input-group label {
    font-weight: bold;
    color: #1a237e;
    text-transform: uppercase;
    font-size: 14px;
}

.search-input-group select {
    width: 100%;
    padding: 12px;
    font-size: 16px;
}

/* ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø­Ø§ÙˆÙŠØ© Ø§Ù„ÙƒÙˆØ¯ ÙˆØ§Ù„Ù…Ø§Ø³Ø­ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¨Ø­Ø« ==== */
.search-code-scan-container {
    display: flex;
    flex-direction: row;
    gap: 8px;
    width: 100%;
    box-sizing: border-box;
    justify-content: center;
    align-items: center;
}

.search-code-scan-container input {
    width: 180px !important;
    max-width: 180px !important;
    min-width: 180px !important;
    flex: 0 0 auto !important;
    text-align: center;
    font-weight: bold;
    letter-spacing: 1px;
    border: 2px solid #1a237e;
}

.search-code-scan-container button {
    width: 180px !important;
    max-width: 180px !important;
    min-width: 180px !important;
    margin-top: 0;
    border: none !important;
    background: linear-gradient(145deg, #e67e22, #d35400) !important;
    color: white !important;
    font-weight: bold;
}

.search-code-scan-container button:hover {
    background: linear-gradient(145deg, #d35400, #e67e22) !important;
    transform: translateY(-2px);
}

.search-buttons {
    display: flex;
    gap: 10px;
    margin: 20px 0;
    width: 100%;
}

.search-buttons button {
    flex: 1;
    padding: 12px;
    font-size: 16px;
    border-radius: 8px;
    font-weight: bold;
    text-transform: uppercase;
}

#searchBackButton {
    background: linear-gradient(145deg, #95a5a6, #7f8c8d);
}

#searchBackButton:hover {
    background: linear-gradient(145deg, #7f8c8d, #6c7b7d);
}

#performSearchButton {
    background: linear-gradient(145deg, #3498db, #2980b9);
}

#performSearchButton:hover {
    background: linear-gradient(145deg, #2980b9, #2471a3);
}

.pdf-buttons {
    display: flex;
    gap: 10px;
    margin: 20px 0;
    width: 100%;
}

.pdf-buttons button {
    flex: 1;
    padding: 12px;
    font-size: 16px;
    border-radius: 8px;
    font-weight: bold;
    text-transform: uppercase;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

#downloadPDF {
    background: linear-gradient(145deg, #2e7d32, #1b5e20);
}

#downloadPDF:hover {
    background: linear-gradient(145deg, #388e3c, #2e7d32);
}

#sharePDF {
    background: linear-gradient(145deg, #8e44ad, #6c3483);
}

#sharePDF:hover {
    background: linear-gradient(145deg, #7d3c98, #5e3370);
}

.search-results-title {
    background: linear-gradient(145deg, #795548, #5d4037);
    color: white;
    padding: 12px;
    border-radius: 10px;
    text-align: center;
    margin: 20px 0;
    font-weight: bold;
    text-transform: uppercase;
    width: 100%;
}

.page-container {
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
}

/* ==== ØµÙØ­Ø© CASSE FRAIS ==== */
.casse-frais-page {
    display: none;
    width: 95%;
    max-width: 600px;
    flex-direction: column;
    align-items: center;
}

/* ==== Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ==== */
.edit-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    z-index: 10000;
    justify-content: center;
    align-items: center;
}

.edit-content {
    background: white;
    padding: 20px;
    border-radius: 10px;
    width: 90%;
    max-width: 400px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}

.edit-input-group {
    margin-bottom: 15px;
}

.edit-input-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
    color: #1a237e;
}

.edit-input-group input {
    width: 100%;
    padding: 8px;
    border: 2px solid #1a237e;
    border-radius: 6px;
    box-sizing: border-box;
}

.edit-buttons {
    display: flex;
    gap: 10px;
    margin-top: 20px;
}

.edit-buttons button {
    flex: 1;
    padding: 10px;
    border: none;
    border-radius: 6px;
    font-weight: bold;
    cursor: pointer;
}

#saveEditButton {
    background: linear-gradient(145deg, #2ecc71, #27ae60);
    color: white;
}

#cancelEditButton {
    background: linear-gradient(145deg, #95a5a6, #7f8c8d);
    color: white;
}

/* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© */
@media (max-width: 480px) {
    .user-inputs-container {
        flex-direction: column;
    }
    
    .card {
        flex-direction: row;
        text-align: left;
        padding: 10px;
    }
    
    .card-image-container {
        width: 70px;
        height: 70px;
    }
    
    .card-header {
        flex-wrap: wrap;
        gap: 5px;
    }
    
    .days-left {
        font-size: 11px;
        padding: 5px 8px;
    }
    
    .card-code {
        font-size: 13px;
    }
    
    .card-details {
        flex-direction: row;
        gap: 10px;
        font-size: 12px;
        padding: 6px 10px;
    }
    
    .date-quantity-container {
        flex-direction: row;
        gap: 6px;
        justify-content: center;
    }
    
    .code-scan-container {
        flex-direction: row;
        gap: 6px;
    }
    
    #codeInput, #scanButton, #casseFraisCodeInput, #casseFraisScanButton {
        width: 150px !important;
        max-width: 150px !important;
        min-width: 150px !important;
        font-size: 13px;
    }
    
    .search-code-scan-container input, .search-code-scan-container button {
        width: 150px !important;
        max-width: 150px !important;
        min-width: 150px !important;
        font-size: 13px;
    }
    
    .camera-controls {
        bottom: 20px;
        gap: 10px;
    }
    
    #captureButton, #closeCameraButton {
        width: 120px !important;
        min-width: 120px !important;
        padding: 10px 15px !important;
        font-size: 14px !important;
    }
    
    .button-row {
        flex-direction: row;
        gap: 6px;
    }
    
    .button-row button {
        min-height: 40px;
        padding: 10px 6px;
        font-size: 12px;
    }
    
    #expiryInput, #quantityInput, #casseFraisExpiryInput, #casseFraisQuantityInput {
        width: 150px !important;
        max-width: 150px !important;
        min-width: 150px !important;
        font-size: 13px;
    }
    
    .month-section {
        flex-wrap: nowrap;
        padding: 8px 10px;
    }
    
    .section-delete-btn {
        width: 100px;
        font-size: 11px;
        padding: 6px 12px;
    }
    
    .month-count {
        width: 25px;
        height: 25px;
        font-size: 12px;
    }
    
    @media (max-width: 320px) {
        .button-row button {
            font-size: 11px;
            padding: 8px 4px;
        }
        
        .date-quantity-container {
            gap: 4px;
        }
        
        #codeInput, #scanButton, #expiryInput, #quantityInput, 
        #casseFraisCodeInput, #casseFraisScanButton, #casseFraisExpiryInput, #casseFraisQuantityInput {
            width: 140px !important;
            max-width: 140px !important;
            min-width: 140px !important;
            font-size: 12px;
        }
        
        .search-code-scan-container input, .search-code-scan-container button {
            width: 140px !important;
            max-width: 140px !important;
            min-width: 140px !important;
            font-size: 12px;
        }
        
        .camera-controls {
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        
        #captureButton, #closeCameraButton {
            width: 160px !important;
            min-width: 160px !important;
        }
    }
}
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

</head>
<body>

<!-- Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
<div id="mainPage" class="page-container">
    <div class="storage-info" id="storageInfo">
        ğŸ’¾ Chargement des donnÃ©es...
    </div>
    
    <h2>SUIVI DLC PRO</h2>

    <!-- ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 1: Ø¥Ø·Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„Ø±Ø§ÙŠÙˆÙ† Ø¨Ø­Ø¬Ù… Ø£ØµØºØ± ==== -->
    <div class="user-inputs-container">
        <div class="user-input-group">
            <input type="text" id="userNameInput" placeholder="NOM D'EMPLOYÃ‰">
        </div>
        <div class="user-input-group">
            <select id="rayonSelect">
                <option value="">RAYON</option>
                <option value="LIQUIDE">LIQUIDE</option>
                <option value="EPICERIE">EPICERIE</option>
                <option value="BISCUITERIE">BISCUITERIE</option>
                <option value="ENTRETIEN">ENTRETIEN</option>
                <option value="BEAUTE-SANTE">BEAUTE-SANTE</option>
                <option value="STAND TRAITEUR">STAND TRAITEUR</option>
                <option value="CHARCUTERIE">CHARCUTERIE</option>
                <option value="STAND">STAND</option>
                <option value="CREMERIE">CREMERIE</option>
                <option value="SURGELE">SURGELE</option>
                <option value="BOUCHERIE">BOUCHERIE</option>
                <option value="VOLAILLE">VOLAILLE</option>
                <option value="BOULANGERIE">BOULANGERIE</option>
                <option value="PATISSERIE">PATISSERIE</option>
                <option value="POISSONNERIE">POISSONNERIE</option>
                <option value="BOULANGERIE PATISSERIE NEGOCE">BOULANGERIE PATISSERIE NEGOCE</option>
                <option value="FRUIT ET LEGUM">FRUIT ET LEGUM</option>
                <option value="PRODUITS VRACS">PRODUITS VRACS</option>
            </select>
        </div>
    </div>

    <div class="inputs-container">
        <div class="input-group">
            <div class="code-scan-container">
                <input id="codeInput" type="number" placeholder="Code produit" maxlength="13">
                <button id="scanButton">SCANNER</button>
            </div>
            <div id="reader"></div>
        </div>

        <div class="input-group">
            <!-- ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø­Ù‚Ù„ Ø¥Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ ÙƒÙ… textarea ==== -->
            <textarea id="nameOutput" class="product-name-textarea" placeholder="Nom produit" readonly rows="2"></textarea>
        </div>

        <div class="input-group">
            <div class="date-quantity-container">
                <input id="expiryInput" type="text" placeholder="DATE" maxlength="10" inputmode="numeric">
                <!-- ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 1: ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© QUANTITÃ‰ (Optionnel) Ø¥Ù„Ù‰ QUANTITÃ‰ ==== -->
                <input id="quantityInput" type="number" placeholder="QUANTITÃ‰" max="9999">
            </div>
        </div>

        <div class="input-group">
            <div class="image-container">
                <div class="stock-icon" id="stockButton">ğŸ–¼ï¸</div>
                <img id="previewImage" src="" alt="">
                <div class="camera-icon" id="cameraButton">ğŸ“·</div>
            </div>
            <input type="file" id="imageInput" accept="image/*" style="display:none;">
        </div>

        <!-- ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 3: Ø¥Ø¹Ø§Ø¯Ø© ØªÙ†Ø¸ÙŠÙ… Ø§Ù„Ø£Ø²Ø±Ø§Ø± ==== -->
        <div class="buttons-container">
            <div class="button-row">
                <button id="addButton">â• AJOUTER</button>
                <button id="importButton">ğŸ“¥ IMPORTER</button>
            </div>
            <div class="button-row">
                <button id="downloadXLSX">ğŸ“Š TELECHARGER</button>
                <button id="shareButton">ğŸ”— PARTAGER</button>
            </div>
            <!-- ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 3: Ø²Ø±ÙŠÙ† RECHERCHE Ùˆ CASSE FRAIS ÙÙŠ Ù†ÙØ³ Ø§Ù„Ø­Ø§ÙˆÙŠØ© ==== -->
            <div class="button-row">
                <button id="searchButton">ğŸ” RECHERCHE</button>
                <button id="casseFraisButton">ğŸ“¦ CASSE FRAIS</button>
            </div>
        </div>
    </div>

    <!-- ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 4: ØªÙˆØ³ÙŠØ¹ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† NOMBRE DES PRODUITS ÙˆØ§Ù„Ø£Ø²Ø±Ø§Ø± ==== -->
    <div style="height: 15px;"></div>

    <!-- ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 5: ØªØºÙŠÙŠØ± Ù„ÙˆÙ† NOMBRE DES PRODUITS ==== -->
    <p id="productCount">NOMBRE DES PRODUITS: <span id="productCountNumber" class="month-count">0</span></p>
    
    <!-- ==== Ø²Ø± SUPPRIMER TOUT ==== -->
    <div class="delete-all-container">
        <button id="deleteAllButton">SUPPRIMER TOUT</button>
    </div>
    
    <div class="cards-container" id="cardsContainer"></div>
</div>

<!-- ØµÙØ­Ø© Ø§Ù„Ø¨Ø­Ø« -->
<div id="searchPage" class="search-page">
    <h2>RECHERCHE</h2>
    <div class="search-inputs">
        <!-- ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø¥Ø¶Ø§ÙØ© Ø­Ø§ÙˆÙŠØ© Ø§Ù„ÙƒÙˆØ¯ ÙˆØ§Ù„Ù…Ø§Ø³Ø­ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¨Ø­Ø« ==== -->
        <div class="search-input-group">
            <label for="codeSearch">Recherche par Code Produit</label>
            <div class="search-code-scan-container">
                <!-- ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 2: ØªØºÙŠÙŠØ± Ø§Ù„Ù†Øµ Ù…Ù† "Entrez le code produit" Ø¥Ù„Ù‰ "Code produit" ==== -->
                <input type="number" id="codeSearch" placeholder="Code produit" maxlength="13">
                <button id="searchScanButton">SCANNER</button>
            </div>
        </div>
        <div class="search-input-group">
            <label for="dateSearch">Recherche par Date (DD/MM/YYYY)</label>
            <select id="dateSearch">
                <option value="">SÃ©lectionnez une date</option>
            </select>
        </div>
        <div class="search-input-group">
            <label for="monthSearch">Recherche par Mois (MM/YYYY)</label>
            <select id="monthSearch">
                <option value="">SÃ©lectionnez un mois</option>
            </select>
        </div>
    </div>
    <div class="search-buttons">
        <button id="searchBackButton">â¬…ï¸ RETOUR</button>
        <button id="performSearchButton">ğŸ” RECHERCHER</button>
    </div>
    <div class="search-results-title" id="searchResultsTitle" style="display: none;">
        RÃ‰SULTATS DE RECHERCHE
    </div>
    <div class="cards-container" id="searchResultsContainer"></div>
    <div class="pdf-buttons" id="pdfButtons" style="display: none;">
        <button id="downloadPDF">ğŸ“¥ TELECHARGER</button>
        <button id="sharePDF">ğŸ”— PARTAGER</button>
    </div>
</div>

<!-- ØµÙØ­Ø© CASSE FRAIS -->
<div id="casseFraisPage" class="casse-frais-page">
    <h2>CASSE FRAIS</h2>

    <!-- Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø¥Ø²Ø§Ù„Ø© Ø¥Ø·Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„Ø±Ø§ÙŠÙˆÙ† Ù…Ù† ØµÙØ­Ø© CASSE FRAIS -->
    <div class="inputs-container">
        <div class="input-group">
            <div class="code-scan-container">
                <input id="casseFraisCodeInput" type="number" placeholder="Code produit" maxlength="13">
                <button id="casseFraisScanButton">SCANNER</button>
            </div>
            <div id="casseFraisReader"></div>
        </div>

        <!-- ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø­Ù‚Ù„ Ø¥Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ ÙƒÙ… textarea ÙÙŠ ØµÙØ­Ø© CASSE FRAIS ==== -->
        <div class="input-group">
            <textarea id="casseFraisNameOutput" class="product-name-textarea" placeholder="Nom produit" readonly rows="2"></textarea>
        </div>

        <div class="input-group">
            <div class="date-quantity-container">
                <input id="casseFraisExpiryInput" type="text" placeholder="DATE" maxlength="10" inputmode="numeric">
                <!-- ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 3: Ø¥Ø¬Ø¨Ø§Ø± Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒÙ…ÙŠØ© ÙÙŠ ØµÙØ­Ø© CASSE FRAIS ==== -->
                <input id="casseFraisQuantityInput" type="number" placeholder="QUANTITÃ‰" max="9999" required>
            </div>
        </div>

        <div class="buttons-container">
            <div class="button-row">
                <button id="casseFraisAddButton">â• AJOUTER</button>
            </div>
            <div class="button-row">
                <button id="casseFraisDownloadXLSX">ğŸ“Š TELECHARGER</button>
                <button id="casseFraisShareButton">ğŸ”— PARTAGER</button>
            </div>
        </div>
    </div>

    <button id="casseFraisBackButton" style="width:95%; max-width:600px; margin:15px 0; background:linear-gradient(145deg, #95a5a6, #7f8c8d);">â¬…ï¸ RETOUR</button>

    <!-- ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 5: ØªØºÙŠÙŠØ± Ù„ÙˆÙ† NOMBRE DES PRODUITS ÙÙŠ ØµÙØ­Ø© CASSE FRAIS ==== -->
    <p id="casseFraisProductCount">NOMBRE DES PRODUITS: <span id="casseFraisProductCountNumber" class="month-count">0</span></p>
    
    <!-- ==== Ø²Ø± SUPPRIMER TOUT ÙÙŠ ØµÙØ­Ø© CASSE FRAIS ==== -->
    <div class="delete-all-container">
        <button id="casseFraisDeleteAllButton">SUPPRIMER TOUT</button>
    </div>
    
    <div class="cards-container" id="casseFraisCardsContainer"></div>
</div>

<!-- Ù†ÙˆØ§ÙØ° Ø¥Ø¶Ø§ÙÙŠØ© -->
<div id="cameraOverlay">
    <video id="cameraVideo" autoplay></video>
    <div class="camera-controls">
        <button id="captureButton">ğŸ“¸ CAPTURER</button>
        <button id="closeCameraButton">âŒ FERMER</button>
    </div>
</div>

<div id="scannerOverlay" class="scanner-overlay" style="display: none;">
    <div class="scanner-frame" id="scannerFrame"></div>
    <div class="scanner-controls">
        <button id="toggleTorch">ğŸ’¡ FLASH</button>
        <button id="closeScanner">âŒ FERMER</button>
    </div>
    <div class="loading-spinner" id="scannerLoading"></div>
</div>

<!-- Ù…Ø§Ø³Ø­ Ø¶ÙˆØ¦ÙŠ Ø¥Ø¶Ø§ÙÙŠ Ù„ØµÙØ­Ø© CASSE FRAIS -->
<div id="casseFraisScannerOverlay" class="scanner-overlay" style="display: none;">
    <div class="scanner-frame" id="casseFraisScannerFrame"></div>
    <div class="scanner-controls">
        <button id="casseFraisToggleTorch">ğŸ’¡ FLASH</button>
        <button id="casseFraisCloseScanner">âŒ FERMER</button>
    </div>
    <div class="loading-spinner" id="casseFraisScannerLoading"></div>
</div>

<!-- Ù…Ø§Ø³Ø­ Ø¶ÙˆØ¦ÙŠ Ø¥Ø¶Ø§ÙÙŠ Ù„ØµÙØ­Ø© Ø§Ù„Ø¨Ø­Ø« -->
<div id="searchScannerOverlay" class="scanner-overlay" style="display: none;">
    <div class="scanner-frame" id="searchScannerFrame"></div>
    <div class="scanner-controls">
        <button id="searchToggleTorch">ğŸ’¡ FLASH</button>
        <button id="searchCloseScanner">âŒ FERMER</button>
    </div>
    <div class="loading-spinner" id="searchScannerLoading"></div>
</div>

<div id="editModal" class="edit-modal">
    <div class="edit-content">
        <h3>Modifier le produit</h3>
        <div class="edit-input-group">
            <label for="editExpiry">DATE</label>
            <input type="text" id="editExpiry" placeholder="DATE" maxlength="10" inputmode="numeric" oninput="autoAdvanceDate(this)">
        </div>
        <div class="edit-input-group">
            <label for="editQuantity">QUANTITÃ‰</label>
            <input type="number" id="editQuantity" placeholder="QUANTITÃ‰" max="9999" inputmode="numeric">
        </div>
        <div class="edit-input-group">
            <label for="editImage">Image</label>
            <input type="file" id="editImage" accept="image/*">
        </div>
        <div class="edit-buttons">
            <button id="saveEditButton">ğŸ’¾ SAUVEGARDER</button>
            <button id="cancelEditButton">âŒ ANNULER</button>
        </div>
    </div>
</div>

<!-- ==== Ù†Ø§ÙØ°Ø© Ø§Ù„Ø­ÙˆØ§Ø± Ø§Ù„Ù…Ø®ØµØµØ© ==== -->
<div id="customConfirmModal" class="custom-confirm-modal">
    <div class="confirm-dialog">
        <h3 class="confirm-title" id="confirmTitle">Confirmation</h3>
        <p class="confirm-message" id="confirmMessage">Message</p>
        <div class="confirm-buttons">
            <button id="confirmCancelBtn" class="confirm-btn confirm-cancel">ANNULER</button>
            <button id="confirmOkBtn" class="confirm-btn confirm-ok">OK</button>
        </div>
    </div>
</div>

<!-- ==== Ù†Ø§ÙØ°Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ§Ù„Ù…Ø´Ø§Ø±ÙƒØ© ==== -->
<div id="downloadShareModal" class="download-share-modal">
    <div class="download-share-content">
        <h3 class="download-share-title" id="downloadShareTitle">SÃ©lection</h3>
        <div class="download-share-options">
            <div class="download-share-option" data-option="all">Tous les mois</div>
            <div class="download-share-option" data-option="month">Choisir un mois</div>
            <div class="download-share-option" data-option="today">Choisir un jour</div>
        </div>
        <div class="month-selection" id="monthSelection">
            <select id="monthSelect">
                <option value="">SÃ©lectionnez un mois</option>
            </select>
        </div>
        <div class="day-selection" id="daySelection">
            <select id="daySelect">
                <option value="">SÃ©lectionnez un jour</option>
            </select>
        </div>
        <div class="confirm-buttons">
            <button id="downloadShareCancelBtn" class="confirm-btn confirm-cancel">ANNULER</button>
            <button id="downloadShareOkBtn" class="confirm-btn confirm-ok">CONFIRMER</button>
        </div>
    </div>
</div>

<!-- ==== Ù†Ø§ÙØ°Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ù„ØµÙØ­Ø© Ø§Ù„Ø¨Ø­Ø« ==== -->
<div id="downloadShareModalSearch" class="download-share-modal-search">
    <div class="download-share-content-search">
        <h3 class="download-share-title-search" id="downloadShareTitleSearch">SÃ©lection</h3>
        <div class="download-share-options-search">
            <div class="download-share-option-search" data-option="pdf">PDF</div>
            <div class="download-share-option-search" data-option="excel">EXCEL</div>
        </div>
        <div class="confirm-buttons">
            <button id="downloadShareCancelBtnSearch" class="confirm-btn confirm-cancel">ANNULER</button>
            <button id="downloadShareOkBtnSearch" class="confirm-btn confirm-ok">CONFIRMER</button>
        </div>
    </div>
</div>

<!-- ==== Ù†Ø§ÙØ°Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© ==== -->
<div id="productHistoryModal" class="product-history-modal">
    <div class="product-history-content">
        <h3 class="product-history-title" id="productHistoryTitle">Historique du Produit</h3>
        <div class="product-history-list" id="productHistoryList">
            <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦Ø© Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª -->
        </div>
        <div class="confirm-buttons">
            <button id="closeHistoryBtn" class="confirm-btn confirm-cancel">FERMER</button>
        </div>
    </div>
</div>

<!-- Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø£Ø¹Ù„Ù‰ - Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
<button class="scroll-to-top" id="scrollToTopMain">â†‘</button>

<!-- Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø£Ø¹Ù„Ù‰ - ØµÙØ­Ø© Ø§Ù„Ø¨Ø­Ø« -->
<button class="scroll-to-top" id="scrollToTopSearch">â†‘</button>

<!-- Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø£Ø¹Ù„Ù‰ - ØµÙØ­Ø© CASSE FRAIS -->
<button class="scroll-to-top" id="scrollToTopCasseFrais">â†‘</button>

<!-- Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­ -->
<div class="success-message" id="successMessage"></div>

<!-- ==== Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ==== -->
<div id="notificationsModal" class="custom-confirm-modal">
    <div class="confirm-dialog">
        <h3 class="confirm-title" id="notificationsTitle">âš ï¸ AVERTISSEMENT DLC</h3>
        <div class="confirm-message" id="notificationsMessage" style="max-height: 300px; overflow-y: auto;">
            <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… Ø¨Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù‚Ø±ÙŠØ¨Ø© Ù…Ù† Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ -->
        </div>
        <div class="confirm-buttons">
            <button id="closeNotificationsBtn" class="confirm-btn confirm-cancel">FERMER</button>
            <button id="viewAllNotificationsBtn" class="confirm-btn confirm-ok">VOIR TOUS</button>
        </div>
    </div>
</div>

<script>
// ==== DATA ====
let database = []; 
let products = [];
let casseFraisProducts = [];
let selectedImageFile = null;
let flashEnabled = false;
let currentStream = null;
let html5QrCode;
let casseFraisHtml5QrCode;
let searchHtml5QrCode;
let db = null;
let searchResults = [];
let currentEditingProduct = null;
let productImages = {};
let currentDownloadShareAction = null;
let notificationCheckInterval = null;
let lastNotificationCheck = 0;
let notificationsEnabled = true;

// ==== Ø§Ù„ØªØµØ­ÙŠØ­: ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø¯ÙˆØ§Ù„ ÙÙŠ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ ====
window.autoAdvanceDate = function(input) {
    let val = input.value.replace(/[^0-9]/g, '');
    
    if (val.length === 2) {
        input.value = val + '/';
    } else if (val.length === 4) {
        input.value = val.substring(0, 2) + '/' + val.substring(2) + '/';
    } else if (val.length > 8) {
        input.value = val.substring(0, 2) + '/' + val.substring(2, 4) + '/' + val.substring(4, 8);
    } else if (val.length > 10) {
        input.value = input.value.substring(0, 10);
    }
};

// ==== Ø¯ÙˆØ§Ù„ Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ø¥Ø­ØªØ±Ø§ÙÙŠØ© ====
function showCustomAlert(title, message, callback = null) {
    const modal = document.getElementById('customConfirmModal');
    const titleElement = document.getElementById('confirmTitle');
    const messageElement = document.getElementById('confirmMessage');
    const cancelBtn = document.getElementById('confirmCancelBtn');
    const okBtn = document.getElementById('confirmOkBtn');

    titleElement.textContent = title;
    messageElement.textContent = message;

    cancelBtn.style.display = 'none';
    okBtn.textContent = 'OK';
    okBtn.className = 'confirm-btn alert-ok';

    modal.style.display = 'flex';

    const handleOk = function() {
        modal.style.display = 'none';
        if (callback) callback();
        okBtn.removeEventListener('click', handleOk);
    };

    okBtn.onclick = handleOk;

    const handleOutsideClick = function(e) {
        if (e.target === modal) {
            modal.style.display = 'none';
            modal.removeEventListener('click', handleOutsideClick);
        }
    };

    modal.addEventListener('click', handleOutsideClick);
}

function showCustomConfirm(count, callback, customTitle = "Confirmation de suppression", customMessage = null) {
    const modal = document.getElementById('customConfirmModal');
    const titleElement = document.getElementById('confirmTitle');
    const messageElement = document.getElementById('confirmMessage');
    const cancelBtn = document.getElementById('confirmCancelBtn');
    const okBtn = document.getElementById('confirmOkBtn');

    if (customMessage) {
        messageElement.textContent = customMessage;
    } else {
        messageElement.innerHTML = `Voulez-vous vraiment supprimer <span id="productCountToDelete">${count}</span> produits ?`;
    }
    
    titleElement.textContent = customTitle;
    
    cancelBtn.style.display = 'block';
    okBtn.textContent = 'SUPPRIMER';
    okBtn.className = 'confirm-btn confirm-ok';
    
    modal.style.display = 'flex';

    const handleCancel = function() {
        modal.style.display = 'none';
        cancelBtn.removeEventListener('click', handleCancel);
        okBtn.removeEventListener('click', handleOk);
    };

    const handleOk = function() {
        modal.style.display = 'none';
        if (callback) callback();
        cancelBtn.removeEventListener('click', handleCancel);
        okBtn.removeEventListener('click', handleOk);
    };

    cancelBtn.onclick = handleCancel;
    okBtn.onclick = handleOk;

    const handleOutsideClick = function(e) {
        if (e.target === modal) {
            modal.style.display = 'none';
            modal.removeEventListener('click', handleOutsideClick);
            cancelBtn.removeEventListener('click', handleCancel);
            okBtn.removeEventListener('click', handleOk);
        }
    };

    modal.addEventListener('click', handleOutsideClick);
}

// ==== Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ====
function checkExpiringProducts() {
    if (!notificationsEnabled) return;
    
    const now = Date.now();
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙƒÙ„ Ø³Ø§Ø¹Ø© ÙÙ‚Ø·
    if (now - lastNotificationCheck < 3600000) return;
    
    lastNotificationCheck = now;
    
    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ØªÙŠ Ø³ØªÙ†ØªÙ‡ÙŠ ØµÙ„Ø§Ø­ÙŠØªÙ‡Ø§ Ø®Ù„Ø§Ù„ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©
    const today = new Date();
    const warningDays = [1, 3, 7, 14]; // Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„ØªÙŠ Ù†Ø±ÙŠØ¯ Ø§Ù„ØªØ­Ø°ÙŠØ± ÙÙŠÙ‡Ø§ (Ø§Ù„ÙŠÙˆÙ…ØŒ 3 Ø£ÙŠØ§Ù…ØŒ Ø£Ø³Ø¨ÙˆØ¹ØŒ Ø£Ø³Ø¨ÙˆØ¹ÙŠÙ†)
    
    let expiringProducts = [];
    
    products.forEach(product => {
        const remaining = daysLeft(product.expiry);
        
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ù†ØªØ¬ Ø³ÙŠÙ†ØªÙ‡ÙŠ Ø®Ù„Ø§Ù„ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
        if (remaining >= 0 && warningDays.includes(remaining)) {
            expiringProducts.push({
                product: product,
                daysLeft: remaining
            });
        }
    });
    
    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù…Ù†ØªØ¬Ø§Øª Ù‚Ø±ÙŠØ¨Ø© Ù…Ù† Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ØŒ Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
    if (expiringProducts.length > 0) {
        showExpiringProductsNotification(expiringProducts);
    }
}

function showExpiringProductsNotification(expiringProducts) {
    const modal = document.getElementById('notificationsModal');
    const title = document.getElementById('notificationsTitle');
    const message = document.getElementById('notificationsMessage');
    
    // ÙØ±Ø² Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© (Ø§Ù„Ø£Ù‚Ø±Ø¨ Ø£ÙˆÙ„Ø§Ù‹)
    expiringProducts.sort((a, b) => a.daysLeft - b.daysLeft);
    
    let messageHTML = '';
    
    expiringProducts.forEach(item => {
        const product = item.product;
        const days = item.daysLeft;
        
        let urgencyColor = '#e74c3c'; // Ø£Ø­Ù…Ø±
        let urgencyText = 'URGENT';
        
        if (days === 14) {
            urgencyColor = '#f39c12'; // Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ
            urgencyText = 'ALERTE';
        } else if (days === 7) {
            urgencyColor = '#f1c40f'; // Ø£ØµÙØ±
            urgencyText = 'ATTENTION';
        } else if (days === 3) {
            urgencyColor = '#e67e22'; // Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ Ø¯Ø§ÙƒÙ†
            urgencyText = 'TRÃˆS PROCHAIN';
        }
        
        messageHTML += `
            <div style="margin-bottom: 15px; padding: 10px; border-left: 4px solid ${urgencyColor}; background: #f8f9fa; border-radius: 5px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <strong style="color: #1a237e;">${product.code}</strong>
                    <span style="background: ${urgencyColor}; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px;">
                        ${urgencyText}
                    </span>
                </div>
                <div style="margin-bottom: 5px;">
                    <strong>${product.name}</strong>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 14px;">
                    <span style="color: #e74c3c;">ğŸ“… ${product.expiry}</span>
                    <span style="color: #27ae60;">ğŸ“¦ ${product.quantity}</span>
                </div>
                <div style="text-align: center; margin-top: 5px; font-weight: bold; color: ${urgencyColor};">
                    â³ ${days === 0 ? 'EXPIRE AUJOURD\'HUI !' : `${days} JOUR${days > 1 ? 'S' : ''} RESTANT${days > 1 ? 'S' : ''}`}
                </div>
            </div>
        `;
    });
    
    messageHTML += `<div style="text-align: center; margin-top: 10px; color: #7f8c8d; font-size: 12px;">
        Total: ${expiringProducts.length} produit${expiringProducts.length > 1 ? 's' : ''} Ã  surveiller
    </div>`;
    
    title.textContent = `âš ï¸ ${expiringProducts.length} PRODUIT${expiringProducts.length > 1 ? 'S' : ''} Ã€ SURVEILLER`;
    message.innerHTML = messageHTML;
    
    modal.style.display = 'flex';
}

// Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
document.getElementById('closeNotificationsBtn').addEventListener('click', function() {
    document.getElementById('notificationsModal').style.display = 'none';
});

// Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù‚Ø±ÙŠØ¨Ø© Ù…Ù† Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
document.getElementById('viewAllNotificationsBtn').addEventListener('click', function() {
    document.getElementById('notificationsModal').style.display = 'none';
    
    // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„Ø¨Ø­Ø« ÙˆØ¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù‚Ø±ÙŠØ¨Ø© Ù…Ù† Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
    const mainPage = document.getElementById('mainPage');
    const searchPage = document.getElementById('searchPage');
    
    mainPage.style.display = 'none';
    searchPage.style.display = 'flex';
    
    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ØªÙŠ Ø³ØªÙ†ØªÙ‡ÙŠ Ø®Ù„Ø§Ù„ 14 ÙŠÙˆÙ…
    const today = new Date();
    const warningDays = 14;
    
    searchResults = products.filter(product => {
        const remaining = daysLeft(product.expiry);
        return remaining >= 0 && remaining <= warningDays;
    });
    
    // ÙØ±Ø² Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù…Ù† Ø§Ù„Ø£Ù‚Ø±Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø¨Ø¹Ø¯
    searchResults.sort((a, b) => {
        const remainingA = daysLeft(a.expiry);
        const remainingB = daysLeft(b.expiry);
        return remainingA - remainingB;
    });
    
    document.getElementById('searchResultsTitle').textContent = `PRODUITS Ã€ SURVEILLER (${searchResults.length})`;
    document.getElementById('searchResultsTitle').style.display = 'block';
    
    displaySearchResults();
});

// ==== ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ====
function initNotificationSystem() {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    setTimeout(() => {
        checkExpiringProducts();
    }, 5000); // ØªØ£Ø®ÙŠØ± 5 Ø«ÙˆØ§Ù†ÙŠ Ù„ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    
    // Ø¶Ø¨Ø· ÙØ­Øµ Ø¯ÙˆØ±ÙŠ ÙƒÙ„ Ø³Ø§Ø¹Ø©
    notificationCheckInterval = setInterval(() => {
        checkExpiringProducts();
    }, 3600000); // ÙƒÙ„ Ø³Ø§Ø¹Ø©
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¹Ù†Ø¯ Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯
    const originalAddButtonClick = document.getElementById('addButton').onclick;
    document.getElementById('addButton').onclick = async function() {
        await originalAddButtonClick?.();
        // Ø¨Ø¹Ø¯ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ØŒ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
        setTimeout(checkExpiringProducts, 1000);
    };
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¹Ù†Ø¯ ØªØ¹Ø¯ÙŠÙ„ Ù…Ù†ØªØ¬
    const originalSaveEditButtonClick = document.getElementById('saveEditButton').onclick;
    document.getElementById('saveEditButton').onclick = async function() {
        await originalSaveEditButtonClick?.();
        // Ø¨Ø¹Ø¯ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ØŒ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
        setTimeout(checkExpiringProducts, 1000);
    };
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¹Ù†Ø¯ Ø­Ø°Ù Ù…Ù†ØªØ¬
    window.deleteProduct = async function(id) {
        try {
            const productExists = products.find(p => p.id === id);
            if (!productExists) {
                showCustomAlert("ERREUR", "Le produit n'existe pas ou a dÃ©jÃ  Ã©tÃ© supprimÃ©.");
                return;
            }

            showCustomConfirm(1, async function() {
                try {
                    await deleteProductById(id);
                    products = products.filter(p => p.id !== id);
                    renderCards();
                    updateStorageInfo();
                    showSuccessMessage("Produit supprimÃ© avec succÃ¨s!");
                    
                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„Ø­Ø°Ù
                    setTimeout(checkExpiringProducts, 1000);
                    
                    if (document.getElementById('searchPage').style.display !== 'none') {
                        const dateSearch = document.getElementById('dateSearch').value;
                        const monthSearch = document.getElementById('monthSearch').value;
                        const codeSearch = document.getElementById('codeSearch').value;
                        if (dateSearch || monthSearch || codeSearch) {
                            document.getElementById('performSearchButton').click();
                        }
                    }
                } catch (error) {
                    console.error('Error deleting product:', error);
                    showCustomAlert("ERREUR", "Erreur lors de la suppression du produit: " + error.message);
                }
            });
        } catch (error) {
            console.error('Error in deleteProduct:', error);
            showCustomAlert("ERREUR", "Erreur lors de la suppression du produit: " + error.message);
        }
    };
}

// ==== Ø§Ù„ØªØµØ­ÙŠØ­: Ø¯Ø§Ù„Ø© Ù…Ø­Ø³Ù†Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙƒØ±Ø§Ø± ÙÙŠ IndexedDB ====
async function checkDuplicateInIndexedDB(code, expiry) {
    try {
        if (!db) db = await openDatabase();
        
        return new Promise((resolve, reject) => {
            const transaction = db.transaction([STORE_NAME], 'readonly');
            const store = transaction.objectStore(STORE_NAME);
            
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙÙ‡Ø±Ø³ Ù„Ù„Ø¨Ø­Ø« Ø¨Ø´ÙƒÙ„ Ø£ÙƒØ«Ø± ÙƒÙØ§Ø¡Ø© Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† getAll
            const codeIndex = store.index('code');
            const request = codeIndex.getAll(code);
            
            request.onsuccess = () => {
                const productsWithSameCode = request.result;
                const duplicate = productsWithSameCode.find(p => p.expiry === expiry);
                resolve(!!duplicate);
            };
            request.onerror = () => {
                console.error('Error checking duplicate:', request.error);
                resolve(false);
            };
        });
    } catch (error) {
        console.error('Error in checkDuplicateInIndexedDB:', error);
        return false;
    }
}

// ==== Ø¥Ø²Ø§Ù„Ø© Ù†Ø§ÙØ°Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† XLSX ÙÙ‚Ø· ====
// Ù†Ø¹Ø·Ù„ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± ÙˆÙ†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¯ÙˆØ§Ù„ Ù…Ø¨Ø§Ø´Ø±Ø©

// Ù…Ø¹Ø§Ù„Ø¬ ØªØ­Ù…ÙŠÙ„ XLSX Ù…Ø¨Ø§Ø´Ø±Ø©
function downloadXLSXDirect() {
    if (products.length === 0) {
        showCustomAlert("TELECHARGEMENT", "AUCUN PRODUIT Ã€ TELECHARGER!");
        return;
    }

    // Ø§Ø³ØªØ®Ø¯Ø§Ù… option = 'all' Ù…Ø¨Ø§Ø´Ø±Ø©
    downloadXLSXHandler('all');
}

// Ù…Ø¹Ø§Ù„Ø¬ Ù…Ø´Ø§Ø±ÙƒØ© XLSX Ù…Ø¨Ø§Ø´Ø±Ø©
async function shareXLSXDirect() {
    if (products.length === 0) {
        showCustomAlert("PARTAGE", "AUCUN PRODUIT Ã€ PARTAGER!");
        return;
    }

    // Ø§Ø³ØªØ®Ø¯Ø§Ù… option = 'all' Ù…Ø¨Ø§Ø´Ø±Ø©
    await shareXLSXHandler('all');
}

// Ù…Ø¹Ø§Ù„Ø¬ ØªØ­Ù…ÙŠÙ„ XLSX Ù„Ù€ CASSE FRAIS Ù…Ø¨Ø§Ø´Ø±Ø©
function downloadCasseFraisXLSXDirect() {
    if (casseFraisProducts.length === 0) {
        showCustomAlert("TELECHARGEMENT", "AUCUN PRODUIT Ã€ TELECHARGER!");
        return;
    }

    // Ø§Ø³ØªØ®Ø¯Ø§Ù… option = 'all' Ù…Ø¨Ø§Ø´Ø±Ø©
    downloadCasseFraisXLSXHandler('all');
}

// Ù…Ø¹Ø§Ù„Ø¬ Ù…Ø´Ø§Ø±ÙƒØ© XLSX Ù„Ù€ CASSE FRAIS Ù…Ø¨Ø§Ø´Ø±Ø©
async function shareCasseFraisXLSXDirect() {
    if (casseFraisProducts.length === 0) {
        showCustomAlert("PARTAGE", "AUCUN PRODUIT Ã€ PARTAGER!");
        return;
    }

    // Ø§Ø³ØªØ®Ø¯Ø§Ù… option = 'all' Ù…Ø¨Ø§Ø´Ø±Ø©
    await shareCasseFraisXLSXHandler('all');
}

// Ù†Ø¹Ø·Ù„ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± ÙˆÙ†Ø³ØªØ¨Ø¯Ù„Ù‡Ø§ Ø¨Ø§Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
document.getElementById('downloadXLSX').addEventListener('click', downloadXLSXDirect);
document.getElementById('shareButton').addEventListener('click', shareXLSXDirect);
document.getElementById('casseFraisDownloadXLSX').addEventListener('click', downloadCasseFraisXLSXDirect);
document.getElementById('casseFraisShareButton').addEventListener('click', shareCasseFraisXLSXDirect);

// ==== Ù†Ø§ÙØ°Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ§Ù„Ù…Ø´Ø§Ø±ÙƒØ© ====
function showDownloadShareModal(action) {
    currentDownloadShareAction = action;
    const modal = document.getElementById('downloadShareModal');
    const title = document.getElementById('downloadShareTitle');
    const options = document.querySelectorAll('.download-share-option');
    const monthSelection = document.getElementById('monthSelection');
    const daySelection = document.getElementById('daySelection');
    const monthSelect = document.getElementById('monthSelect');
    const daySelect = document.getElementById('daySelect');
    
    // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø­Ø³Ø¨ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡
    title.textContent = action === 'download' ? 'TELECHARGER' : 'PARTAGER';
    
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª
    options.forEach(option => {
        option.classList.remove('selected');
    });
    monthSelection.style.display = 'none';
    daySelection.style.display = 'none';
    monthSelect.value = '';
    daySelect.value = '';
    
    // ØªØ¹Ø¨Ø¦Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø´Ù‡Ø± ÙˆØ§Ù„Ø£ÙŠØ§Ù…
    populateMonthSelect();
    populateDaySelect();
    
    modal.style.display = 'flex';
    
    // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ù„Ø®ÙŠØ§Ø±Ø§Øª
    options.forEach(option => {
        option.onclick = function() {
            options.forEach(opt => opt.classList.remove('selected'));
            this.classList.add('selected');
            
            if (this.dataset.option === 'month') {
                monthSelection.style.display = 'block';
                daySelection.style.display = 'none';
            } else if (this.dataset.option === 'today') {
                daySelection.style.display = 'block';
                monthSelection.style.display = 'none';
            } else {
                monthSelection.style.display = 'none';
                daySelection.style.display = 'none';
            }
        };
    });
    
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ù„Ø£Ø²Ø±Ø§Ø±
    document.getElementById('downloadShareCancelBtn').onclick = function() {
        modal.style.display = 'none';
    };
    
    document.getElementById('downloadShareOkBtn').onclick = function() {
        const selectedOption = document.querySelector('.download-share-option.selected');
        if (!selectedOption) {
            showCustomAlert("SÃ‰LECTION", "Veuillez sÃ©lectionner une option");
            return;
        }
        
        const option = selectedOption.dataset.option;
        let selectedMonth = '';
        let selectedDay = '';
        
        if (option === 'month') {
            selectedMonth = monthSelect.value;
            if (!selectedMonth) {
                showCustomAlert("SÃ‰LECTION", "Veuillez sÃ©lectionner un mois");
                return;
            }
        } else if (option === 'today') {
            selectedDay = daySelect.value;
            if (!selectedDay) {
                showCustomAlert("SÃ‰LECTION", "Veuillez sÃ©lectionner un jour");
                return;
            }
        }
        
        modal.style.display = 'none';
        
        // ØªÙ†ÙÙŠØ° Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
        if (currentDownloadShareAction === 'download') {
            downloadXLSXHandler(option, selectedMonth, selectedDay);
        } else {
            shareXLSXHandler(option, selectedMonth, selectedDay);
        }
    };
}

// Ù…Ø¹Ø§Ù„Ø¬ ØªØ­Ù…ÙŠÙ„ XLSX
function downloadXLSXHandler(option, selectedMonth, selectedDay) {
    if (products.length === 0) {
        showCustomAlert("TELECHARGEMENT", "AUCUN PRODUIT Ã€ TELECHARGER!");
        return;
    }

    let productsToExport = [];
    
    if (option === 'all') {
        productsToExport = products;
    } else if (option === 'month') {
        const [month, year] = selectedMonth.split('/');
        productsToExport = products.filter(product => {
            const [d, m, y] = product.expiry.split('/');
            return m === month && y === year;
        });
        
        if (productsToExport.length === 0) {
            showCustomAlert("TELECHARGEMENT", "AUCUN PRODUIT POUR CE MOIS!");
            return;
        }
    } else if (option === 'today') {
        productsToExport = products.filter(product => product.expiry === selectedDay);
        
        if (productsToExport.length === 0) {
            showCustomAlert("TELECHARGEMENT", "AUCUN PRODUIT POUR CE JOUR!");
            return;
        }
    }

    // ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† Ø§Ù„Ø£Ù‚Ø±Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø¨Ø¹Ø¯
    productsToExport = sortProductsByExpiry(productsToExport);

    const ws = XLSX.utils.json_to_sheet(productsToExport.map(p => ({
        Code: p.code,
        Nom: p.name,
        Date: p.expiry,
        QuantitÃ©: p.quantity
    })));

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Produits");

    const wbout = XLSX.write(wb, { bookType: "xlsx", type: "array" });
    const blob = new Blob([wbout], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
    const url = URL.createObjectURL(blob);

    window.location.href = url;
}

// Ù…Ø¹Ø§Ù„Ø¬ Ù…Ø´Ø§Ø±ÙƒØ© XLSX
async function shareXLSXHandler(option, selectedMonth, selectedDay) {
    if (products.length === 0) {
        showCustomAlert("PARTAGE", "AUCUN PRODUIT Ã€ PARTAGER!");
        return;
    }

    try {
        let productsToExport = [];
        
        if (option === 'all') {
            productsToExport = products;
        } else if (option === 'month') {
            const [month, year] = selectedMonth.split('/');
            productsToExport = products.filter(product => {
                const [d, m, y] = product.expiry.split('/');
                return m === month && y === year;
            });
            
            if (productsToExport.length === 0) {
                showCustomAlert("PARTAGE", "AUCUN PRODUIT POUR CE MOIS!");
                return;
            }
        } else if (option === 'today') {
            productsToExport = products.filter(product => product.expiry === selectedDay);
            
            if (productsToExport.length === 0) {
                showCustomAlert("PARTAGE", "AUCUN PRODUIT POUR CE JOUR!");
                return;
            }
        }

    // ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† Ø§Ù„Ø£Ù‚Ø±Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø¨Ø¹Ø¯
    productsToExport = sortProductsByExpiry(productsToExport);

    const ws = XLSX.utils.json_to_sheet(productsToExport.map(p => ({
        Code: p.code,
        Nom: p.name,
        Date: p.expiry,
        QuantitÃ©: p.quantity,
        "Jours Restants": daysLeft(p.expiry)
    })));

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Produits DLC");

    const wbout = XLSX.write(wb, { bookType: "xlsx", type: "array" });
    const blob = new Blob([wbout], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });

    if (navigator.share) {
        try {
            const file = new File([blob], "Produits_DLC.xlsx", { 
                type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" 
            });
            
            await navigator.share({
                type: "file",
                url: URL.createObjectURL(blob),
                extension: "xlsx",
                text: `ğŸ“‹ SUIVI DLC - Liste des Produits\n${productsToExport.length} produits\nGÃ©nÃ©rÃ© le: ${new Date().toLocaleDateString('fr-FR')}`
            });
            
            showSuccessMessage("Fichier partagÃ© avec succÃ¨s!");
            return;
            
        } catch (shareError) {
            console.log('Web Share API failed:', shareError);
        }
    }

    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = "Produits_DLC.xlsx";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showSuccessMessage("Fichier tÃ©lÃ©chargÃ©! Vous pouvez maintenant le partager manuellement.");
    
    } catch (err) {
        console.error('Erreur de partage:', err);
        showCustomAlert("ERREUR", "Erreur lors du partage du fichier: " + err.message);
    }
}

// Ù…Ø¹Ø§Ù„Ø¬ ØªØ­Ù…ÙŠÙ„ XLSX Ù„Ù€ CASSE FRAIS
function downloadCasseFraisXLSXHandler(option, selectedMonth, selectedDay) {
    if (casseFraisProducts.length === 0) {
        showCustomAlert("TELECHARGEMENT", "AUCUN PRODUIT Ã€ TELECHARGER!");
        return;
    }

    let productsToExport = [];
    
    if (option === 'all') {
        productsToExport = casseFraisProducts;
    } else if (option === 'month') {
        const [month, year] = selectedMonth.split('/');
        productsToExport = casseFraisProducts.filter(product => {
            const [d, m, y] = product.expiry.split('/');
            return m === month && y === year;
        });
        
        if (productsToExport.length === 0) {
            showCustomAlert("TELECHARGEMENT", "AUCUN PRODUIT POUR CE MOIS!");
            return;
        }
    } else if (option === 'today') {
        productsToExport = casseFraisProducts.filter(product => product.expiry === selectedDay);
        
        if (productsToExport.length === 0) {
            showCustomAlert("TELECHARGEMENT", "AUCUN PRODUIT POUR CE JOUR!");
            return;
        }
    }

    // ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† Ø§Ù„Ø£Ù‚Ø±Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø¨Ø¹Ø¯
    productsToExport = sortProductsByExpiry(productsToExport);

    const ws = XLSX.utils.json_to_sheet(productsToExport.map(p => ({
        Code: p.code,
        Nom: p.name,
        Date: p.expiry,
        QuantitÃ©: p.quantity
    })));

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Casse Frais");

    const wbout = XLSX.write(wb, { bookType: "xlsx", type: "array" });
    const blob = new Blob([wbout], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
    const url = URL.createObjectURL(blob);

    window.location.href = url;
}

// Ù…Ø¹Ø§Ù„Ø¬ Ù…Ø´Ø§Ø±ÙƒØ© XLSX Ù„Ù€ CASSE FRAIS
async function shareCasseFraisXLSXHandler(option, selectedMonth, selectedDay) {
    if (casseFraisProducts.length === 0) {
        showCustomAlert("PARTAGE", "AUCUN PRODUIT Ã€ PARTAGER!");
        return;
    }

    try {
        let productsToExport = [];
        
        if (option === 'all') {
            productsToExport = casseFraisProducts;
        } else if (option === 'month') {
            const [month, year] = selectedMonth.split('/');
            productsToExport = casseFraisProducts.filter(product => {
                const [d, m, y] = product.expiry.split('/');
                return m === month && y === year;
            });
            
            if (productsToExport.length === 0) {
                showCustomAlert("PARTAGE", "AUCUN PRODUIT POUR CE MOIS!");
                return;
            }
        } else if (option === 'today') {
            productsToExport = casseFraisProducts.filter(product => product.expiry === selectedDay);
            
            if (productsToExport.length === 0) {
                showCustomAlert("PARTAGE", "AUCUN PRODUIT POUR CE JOUR!");
                return;
            }
        }

        // ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† Ø§Ù„Ø£Ù‚Ø±Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø¨Ø¹Ø¯
        productsToExport = sortProductsByExpiry(productsToExport);

        const ws = XLSX.utils.json_to_sheet(productsToExport.map(p => ({
            Code: p.code,
            Nom: p.name,
            Date: p.expiry,
            QuantitÃ©: p.quantity,
            "Jours Restants": daysLeft(p.expiry)
        })));

        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Casse Frais");

        const wbout = XLSX.write(wb, { bookType: "xlsx", type: "array" });
        const blob = new Blob([wbout], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });

        if (navigator.share) {
            try {
                const file = new File([blob], "Casse_Frais.xlsx", { 
                    type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" 
                });
                
                await navigator.share({
                    type: "file",
                    url: URL.createObjectURL(blob),
                    extension: "xlsx",
                    text: `ğŸ“‹ CASSE FRAIS - Liste des Produits\n${productsToExport.length} produits\nGÃ©nÃ©rÃ© le: ${new Date().toLocaleDateString('fr-FR')}`
                });
                
                showSuccessMessage("Fichier partagÃ© avec succÃ¨s!");
                return;
                
            } catch (shareError) {
                console.log('Web Share API failed:', shareError);
            }
        }

        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = "Casse_Frais.xlsx";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showSuccessMessage("Fichier tÃ©lÃ©chargÃ©! Vous pouvez maintenant le partager manuellement.");
        
    } catch (err) {
        console.error('Erreur de partage:', err);
        showCustomAlert("ERREUR", "Erreur lors du partage du fichier: " + err.message);
    }
}

// ØªØ¹Ø¨Ø¦Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø´Ù‡Ø±
function populateMonthSelect() {
    const monthSelect = document.getElementById('monthSelect');
    monthSelect.innerHTML = '<option value="">SÃ©lectionnez un mois</option>';
    
    const months = getAvailableMonths();
    
    months.forEach(month => {
        const option = document.createElement('option');
        option.value = month;
        option.textContent = month;
        monthSelect.appendChild(option);
    });
}

// ØªØ¹Ø¨Ø¦Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ÙŠØ§Ù…
function populateDaySelect() {
    const daySelect = document.getElementById('daySelect');
    daySelect.innerHTML = '<option value="">SÃ©lectionnez un jour</option>';
    
    const days = getAvailableDays();
    
    days.forEach(day => {
        const option = document.createElement('option');
        option.value = day;
        option.textContent = day;
        daySelect.appendChild(option);
    });
}

// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø´Ù‡Ø± Ø§Ù„Ù…ØªØ§Ø­Ø©
function getAvailableMonths() {
    const months = new Set();
    
    products.forEach(product => {
        const [d,m,y] = product.expiry.split('/');
        const monthKey = `${m}/${y}`;
        months.add(monthKey);
    });
    
    return Array.from(months).sort((a, b) => {
        const [m1, y1] = a.split('/').map(Number);
        const [m2, y2] = b.split('/').map(Number);
        return new Date(y1, m1-1) - new Date(y2, m2-1);
    });
}

// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ØªØ§Ø­Ø©
function getAvailableDays() {
    const days = new Set();
    
    products.forEach(product => {
        days.add(product.expiry);
    });
    
    return Array.from(days).sort((a, b) => {
        const [d1, m1, y1] = a.split('/').map(Number);
        const [d2, m2, y2] = b.split('/').map(Number);
        return new Date(y1, m1-1, d1) - new Date(y2, m2-1, d2);
    });
}

// ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 1: ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† Ø§Ù„Ø£Ù‚Ø±Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø¨Ø¹Ø¯ ====
function sortProductsByExpiry(productsArray) {
    return productsArray.sort((a, b) => {
        const [d1, m1, y1] = a.expiry.split('/').map(Number);
        const [d2, m2, y2] = b.expiry.split('/').map(Number);
        const dateA = new Date(y1, m1-1, d1);
        const dateB = new Date(y2, m2-1, d2);
        return dateA - dateB; // Ø§Ù„Ø£Ù‚Ø±Ø¨ Ø£ÙˆÙ„Ø§Ù‹
    });
}

// ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 1: Ø¹Ø±Ø¶ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ø±ØªØ¨ Ù…Ù† Ø§Ù„Ø£Ù‚Ø±Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø¨Ø¹Ø¯ ====
function showProductHistory(code) {
    const existingProducts = products.filter(p => p.code === code);
    
    if (existingProducts.length === 0) {
        return;
    }

    // ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 1: ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† Ø§Ù„Ø£Ù‚Ø±Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø¨Ø¹Ø¯ ====
    existingProducts.sort((a, b) => {
        const [d1, m1, y1] = a.expiry.split("/").map(Number);
        const [d2, m2, y2] = b.expiry.split("/").map(Number);
        const dateA = new Date(y1, m1-1, d1);
        const dateB = new Date(y2, m2-1, d2);
        return dateA - dateB; // Ø§Ù„Ø£Ù‚Ø±Ø¨ Ø£ÙˆÙ„Ø§Ù‹
    });

    const modal = document.getElementById('productHistoryModal');
    const title = document.getElementById('productHistoryTitle');
    const list = document.getElementById('productHistoryList');
    
    title.textContent = `Historique: ${code}`;
    list.innerHTML = '';
    
    existingProducts.forEach(product => {
        const remaining = daysLeft(product.expiry);
        const daysText = remaining < 0 ? `ExpirÃ© il y a ${Math.abs(remaining)} jours` : 
                         remaining === 0 ? `Expire aujourd'hui` : 
                         `${remaining} jours restants`;
        
        const item = document.createElement('div');
        item.className = 'product-history-item';
        item.innerHTML = `
            <div class="product-history-details">
                <span class="product-history-date">${product.expiry}</span>
                <span class="product-history-quantity">${product.quantity}</span>
            </div>
            <div class="product-history-days">${daysText}</div>
        `;
        list.appendChild(item);
    });
    
    modal.style.display = 'flex';
}

// Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ§Ø±ÙŠØ®
document.getElementById('closeHistoryBtn').addEventListener('click', function() {
    document.getElementById('productHistoryModal').style.display = 'none';
});

// ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 5: Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø£Ø¹Ù„Ù‰ Ù„ÙƒÙ„Ø§ Ø§Ù„ØµÙØ­ØªÙŠÙ† ====
const scrollToTopMain = document.getElementById('scrollToTopMain');
const scrollToTopSearch = document.getElementById('scrollToTopSearch');
const scrollToTopCasseFrais = document.getElementById('scrollToTopCasseFrais');

function setupScrollToTop() {
    const mainPage = document.getElementById('mainPage');
    const searchPage = document.getElementById('searchPage');
    const casseFraisPage = document.getElementById('casseFraisPage');
    
    window.addEventListener('scroll', function() {
        if (window.pageYOffset > 300) {
            if (mainPage.style.display !== 'none') {
                scrollToTopMain.style.display = 'block';
                scrollToTopSearch.style.display = 'none';
                scrollToTopCasseFrais.style.display = 'none';
            } else if (searchPage.style.display !== 'none') {
                scrollToTopMain.style.display = 'none';
                scrollToTopSearch.style.display = 'block';
                scrollToTopCasseFrais.style.display = 'none';
            } else if (casseFraisPage.style.display !== 'none') {
                scrollToTopMain.style.display = 'none';
                scrollToTopSearch.style.display = 'none';
                scrollToTopCasseFrais.style.display = 'block';
            }
        } else {
            scrollToTopMain.style.display = 'none';
            scrollToTopSearch.style.display = 'none';
            scrollToTopCasseFrais.style.display = 'none';
        }
    });

    scrollToTopMain.addEventListener('click', function() {
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    });

    scrollToTopSearch.addEventListener('click', function() {
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    });

    scrollToTopCasseFrais.addEventListener('click', function() {
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    });
}

// ==== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙØ­Ø§Øª ====
const mainPage = document.getElementById('mainPage');
const searchPage = document.getElementById('searchPage');
const casseFraisPage = document.getElementById('casseFraisPage');

// Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©: Ø¥Ø®ÙØ§Ø¡ ØµÙØ­Ø© Ø§Ù„Ø¨Ø­Ø« Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
window.addEventListener('DOMContentLoaded', function() {
    mainPage.style.display = 'flex';
    searchPage.style.display = 'none';
    casseFraisPage.style.display = 'none';
});

document.getElementById('searchButton').addEventListener('click', () => {
    mainPage.style.display = 'none';
    searchPage.style.display = 'flex';
    casseFraisPage.style.display = 'none';
    initializeSearchPage();
    // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø²Ø± ØµÙØ­Ø© Ø§Ù„Ø¨Ø­Ø«
    scrollToTopMain.style.display = 'none';
});

document.getElementById('searchBackButton').addEventListener('click', () => {
    searchPage.style.display = 'none';
    mainPage.style.display = 'flex';
    casseFraisPage.style.display = 'none';
    renderCards();
    // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± ØµÙØ­Ø© Ø§Ù„Ø¨Ø­Ø« ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
    scrollToTopSearch.style.display = 'none';
});

// Ø²Ø± CASSE FRAIS ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
document.getElementById('casseFraisButton').addEventListener('click', () => {
    mainPage.style.display = 'none';
    searchPage.style.display = 'none';
    casseFraisPage.style.display = 'flex';
    renderCasseFraisCards();
    // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø²Ø± ØµÙØ­Ø© CASSE FRAIS
    scrollToTopMain.style.display = 'none';
});

// Ø²Ø± RETOUR ÙÙŠ ØµÙØ­Ø© CASSE FRAIS
document.getElementById('casseFraisBackButton').addEventListener('click', () => {
    // ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: ØªÙØ±ÙŠØº Ø­Ù‚ÙˆÙ„ ØµÙØ­Ø© CASSE FRAIS Ø¹Ù†Ø¯ Ø§Ù„Ø±Ø¬ÙˆØ¹ ====
    document.getElementById('casseFraisCodeInput').value = '';
    document.getElementById('casseFraisNameOutput').value = '';
    document.getElementById('casseFraisExpiryInput').value = '';
    document.getElementById('casseFraisQuantityInput').value = '';
    
    casseFraisPage.style.display = 'none';
    mainPage.style.display = 'flex';
    searchPage.style.display = 'none';
    renderCards();
    // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± ØµÙØ­Ø© CASSE FRAIS ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
    scrollToTopCasseFrais.style.display = 'none';
});

// ØªÙ‡ÙŠØ¦Ø© ØµÙØ­Ø© Ø§Ù„Ø¨Ø­Ø«
function initializeSearchPage() {
    // ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 3: Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ù…Ù„Ø¡ Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø£ÙŠØ§Ù… ÙˆØ§Ù„Ø£Ø´Ù‡Ø± ====
    populateDateSearchFromData();
    populateMonthSearchFromData();
    document.getElementById('searchResultsTitle').style.display = 'none';
    document.getElementById('pdfButtons').style.display = 'none';
    document.getElementById('searchResultsContainer').innerHTML = '';
    document.getElementById('dateSearch').value = '';
    document.getElementById('monthSearch').value = '';
    document.getElementById('codeSearch').value = '';
}

// ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 3: ØªØ¹Ø¨Ø¦Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© ====
function populateDateSearchFromData() {
    const dateSelect = document.getElementById('dateSearch');
    dateSelect.innerHTML = '<option value="">SÃ©lectionnez une date</option>';
    
    const dates = new Set();
    
    products.forEach(product => {
        dates.add(product.expiry);
    });
    
    const sortedDates = Array.from(dates).sort((a, b) => {
        const [d1, m1, y1] = a.split('/').map(Number);
        const [d2, m2, y2] = b.split('/').map(Number);
        return new Date(y1, m1-1, d1) - new Date(y2, m2-1, d2);
    });
    
    sortedDates.forEach(date => {
        const option = document.createElement('option');
        option.value = date;
        option.textContent = date;
        dateSelect.appendChild(option);
    });
}

// ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 3: ØªØ¹Ø¨Ø¦Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø´Ù‡Ø± Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© ====
function populateMonthSearchFromData() {
    const monthSelect = document.getElementById('monthSearch');
    monthSelect.innerHTML = '<option value="">SÃ©lectionnez un mois</option>';
    
    const months = new Set();
    
    products.forEach(product => {
        const [d, m, y] = product.expiry.split('/');
        const monthKey = `${m}/${y}`;
        months.add(monthKey);
    });
    
    const sortedMonths = Array.from(months).sort((a, b) => {
        const [m1, y1] = a.split('/').map(Number);
        const [m2, y2] = b.split('/').map(Number);
        return new Date(y1, m1-1) - new Date(y2, m2-1);
    });
    
    sortedMonths.forEach(month => {
        const option = document.createElement('option');
        option.value = month;
        option.textContent = month;
        monthSelect.appendChild(option);
    });
}

// ØªØ¹Ø¨Ø¦Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„ØªØ§Ø±ÙŠØ®
function populateDateSearch() {
    const dateSelect = document.getElementById('dateSearch');
    dateSelect.innerHTML = '<option value="">SÃ©lectionnez une date</option>';
    
    const today = new Date();
    const threeMonthsLater = new Date(today);
    threeMonthsLater.setMonth(today.getMonth() + 3);
    
    const dates = [];
    const currentDate = new Date(today);
    
    while (currentDate <= threeMonthsLater) {
        const dateStr = formatDateForSearch(currentDate);
        dates.push(dateStr);
        currentDate.setDate(currentDate.getDate() + 1);
    }
    
    dates.forEach(date => {
        const option = document.createElement('option');
        option.value = date;
        option.textContent = date;
        dateSelect.appendChild(option);
    });
}

function formatDateForSearch(date) {
    const day = date.getDate().toString().padStart(2, '0');
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const year = date.getFullYear().toString();
    return `${day}/${month}/${year}`;
}

// ØªØ¹Ø¨Ø¦Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø´Ù‡Ø±
function populateMonthSearch() {
    const monthSelect = document.getElementById('monthSearch');
    monthSelect.innerHTML = '<option value="">SÃ©lectionnez un mois</option>';
    
    const today = new Date();
    const months = [];
    
    for (let i = 0; i < 24; i++) {
        const monthDate = new Date(today);
        monthDate.setMonth(today.getMonth() + i);
        const monthStr = `${(monthDate.getMonth() + 1).toString().padStart(2, '0')}/${monthDate.getFullYear()}`;
        months.push(monthStr);
    }
    
    months.forEach(month => {
        const option = document.createElement('option');
        option.value = month;
        option.textContent = month;
        monthSelect.appendChild(option);
    });
}

// ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„ÙƒÙˆØ¯ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¨Ø­Ø« ====
document.getElementById("codeSearch").addEventListener("input", function(){
    this.value = this.value.replace(/[^0-9]/g, '');
    
    if (this.value.length > 13) {
        this.value = this.value.substring(0, 13);
    }
    
    // ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 4: Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯ ====
    if (this.value.trim() !== '') {
        performSearch();
    }
});

// ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 4: Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„ØªØ§Ø±ÙŠØ® Ø£Ùˆ Ø§Ù„Ø´Ù‡Ø± ====
document.getElementById("dateSearch").addEventListener("change", function() {
    if (this.value !== '') {
        performSearch();
    }
});

document.getElementById("monthSearch").addEventListener("change", function() {
    if (this.value !== '') {
        performSearch();
    }
});

// ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø§Ù„Ù…Ø§Ø³Ø­ Ø§Ù„Ø¶ÙˆØ¦ÙŠ Ù„ØµÙØ­Ø© Ø§Ù„Ø¨Ø­Ø« ====
document.getElementById("searchScanButton").addEventListener("click", async () => {
    await startSearchScanner();
});

async function startSearchScanner() {
    const scannerOverlay = document.getElementById("searchScannerOverlay");
    const scannerFrame = document.getElementById("searchScannerFrame");
    const scannerLoading = document.getElementById("searchScannerLoading");
    
    scannerOverlay.style.display = "flex";
    scannerLoading.style.display = "block";
    
    try {
        if (searchHtml5QrCode && searchHtml5QrCode.isScanning) {
            await searchHtml5QrCode.stop();
        }
        
        searchHtml5QrCode = new Html5Qrcode("searchScannerFrame");
        
        const config = {
            fps: 15,
            qrbox: { width: 250, height: 150 },
            aspectRatio: 1.0,
            disableFlip: false
        };
        
        await searchHtml5QrCode.start(
            { facingMode: "environment" },
            config,
            onSearchScanSuccess,
            onSearchScanFailure
        );
        
        try {
            await searchHtml5QrCode.applyVideoConstraints({
                advanced: [{ torch: true }]
            });
            flashEnabled = true;
            document.getElementById("searchToggleTorch").textContent = "ğŸ’¡ ON";
        } catch (e) {
            console.log("Flash not supported");
        }
        
        scannerLoading.style.display = "none";
        
    } catch (err) {
        console.error("Error starting search scanner:", err);
        scannerOverlay.style.display = 'none';
        showCustomAlert("ERREUR CAMÃ‰RA", "Impossible de dÃ©marrer le scanner. VÃ©rifiez les permissions de la camÃ©ra.");
    }
}

function stopSearchScanner() {
    const scannerOverlay = document.getElementById("searchScannerOverlay");
    
    if (searchHtml5QrCode && searchHtml5QrCode.isScanning) {
        try {
            searchHtml5QrCode.applyVideoConstraints({
                advanced: [{ torch: false }]
            });
            flashEnabled = false;
        } catch (e) {
            console.log("Error turning off flash");
        }
        
        searchHtml5QrCode.stop().then(() => {
            scannerOverlay.style.display = 'none';
        }).catch(err => {
            console.log("Error stopping search scanner:", err);
            scannerOverlay.style.display = 'none';
        });
    } else {
        scannerOverlay.style.display = 'none';
    }
}

function onSearchScanSuccess(decodedText) {
    let scannedCode = decodedText.trim();
    if (scannedCode.length > 13) {
        scannedCode = scannedCode.substring(0, 13);
    }
    
    document.getElementById("codeSearch").value = scannedCode;
    
    showSuccessMessage("Code scannÃ© avec succÃ¨s!");
    stopSearchScanner();
    
    // ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 4: Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø³Ø­ ====
    setTimeout(() => {
        performSearch();
    }, 500);
}

function onSearchScanFailure(error) {
    // Ù„Ø§ ØªÙØ¹Ù„ Ø´ÙŠØ¦Ø§Ù‹ØŒ Ø§Ù„Ù…Ø§Ø³Ø­ Ø³ÙŠØ³ØªÙ…Ø± ÙÙŠ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
}

document.getElementById("searchCloseScanner").addEventListener("click", stopSearchScanner);

// ØªØ¨Ø¯ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„ÙÙ„Ø§Ø´ Ù„ØµÙØ­Ø© Ø§Ù„Ø¨Ø­Ø«
document.getElementById("searchToggleTorch").addEventListener("click", async function() {
    if (!searchHtml5QrCode || !searchHtml5QrCode.isScanning) return;
    
    try {
        flashEnabled = !flashEnabled;
        await searchHtml5QrCode.applyVideoConstraints({
            advanced: [{ torch: flashEnabled }]
        });
        this.textContent = flashEnabled ? "ğŸ’¡ ON" : "ğŸ’¡ OFF";
    } catch (e) {
        console.log("Error toggling flash");
    }
});

// ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 4: Ø¯Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ====
function performSearch() {
    const dateSearch = document.getElementById('dateSearch').value;
    const monthSearch = document.getElementById('monthSearch').value;
    const codeSearch = document.getElementById('codeSearch').value.trim();
    
    // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø£ÙŠ Ù…Ø¹ÙŠØ§Ø± Ø¨Ø­Ø«ØŒ Ù„Ø§ ØªÙØ¹Ù„ Ø´ÙŠØ¦Ø§Ù‹
    if (!dateSearch && !monthSearch && !codeSearch) {
        document.getElementById('searchResultsTitle').style.display = 'none';
        document.getElementById('pdfButtons').style.display = 'none';
        document.getElementById('searchResultsContainer').innerHTML = '';
        return;
    }
    
    searchResults = [];
    
    if (codeSearch) {
        // ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„ÙƒÙˆØ¯ ====
        searchResults = products.filter(product => {
            return product.code === codeSearch;
        });
        
        document.getElementById('searchResultsTitle').textContent = `RÃ‰SULTATS POUR LE CODE: ${codeSearch}`;
    } else if (dateSearch) {
        const [day, month, year] = dateSearch.split('/');
        const searchDateFormatted = `${day}/${month}/${year}`;
        
        searchResults = products.filter(product => {
            return product.expiry === searchDateFormatted;
        });
        
        document.getElementById('searchResultsTitle').textContent = `RÃ‰SULTATS POUR: ${dateSearch}`;
    } else if (monthSearch) {
        const [month, year] = monthSearch.split('/');
        searchResults = products.filter(product => {
            const [d, m, y] = product.expiry.split('/');
            return m === month && y === year;
        });
        
        document.getElementById('searchResultsTitle').textContent = `RÃ‰SULTATS POUR: ${monthSearch}`;
    }
    
    // ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 1: ØªØ±ØªÙŠØ¨ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« Ù…Ù† Ø§Ù„Ø£Ù‚Ø±Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø¨Ø¹Ø¯ ====
    searchResults = sortProductsByExpiry(searchResults);
    
    displaySearchResults();
}

// ØªÙ†ÙÙŠØ° Ø§Ù„Ø¨Ø­Ø«
document.getElementById('performSearchButton').addEventListener('click', performSearch);

// ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« Ù…Ø¹ Ø¥Ø¶Ø§ÙØ© Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ§Ù„Ø­Ø°Ù ====
function displaySearchResults() {
    const container = document.getElementById('searchResultsContainer');
    const title = document.getElementById('searchResultsTitle');
    const pdfButtons = document.getElementById('pdfButtons');
    
    container.innerHTML = '';
    
    if (searchResults.length === 0) {
        container.innerHTML = '<div class="card"><div class="card-content"><div class="card-name">Aucun produit trouvÃ©</div></div></div>';
        title.style.display = 'block';
        pdfButtons.style.display = 'none';
        return;
    }
    
    title.style.display = 'block';
    pdfButtons.style.display = 'flex';
    
    searchResults.forEach((p, index) => {
        const remaining = daysLeft(p.expiry);
        const color = daysColor(remaining);
        const card = document.createElement('div');
        card.className = 'card';
        card.style.borderLeftColor = color;
        card.innerHTML = `
            <div class="card-image-container" onclick="openEditModal(${JSON.stringify(p).replace(/"/g, '&quot;')})">
                ${p.img ? `<img src="${p.img}" alt="">` : ""}
                <div class="edit-overlay">ğŸ“ MODIFIER</div>
            </div>
            <div class="card-content">
                <div class="card-header">
                    <span class="days-left" style="background:${color}">${remaining} JOURS RESTANT</span>
                </div>
                <span class="card-code">${p.code}</span>
                <div class="card-name">${p.name}</div>
                <div class="card-details">
                    <span class="card-date" onclick="openEditModal(${JSON.stringify(p).replace(/"/g, '&quot;')})">DATE: ${p.expiry}</span>
                    <span class="card-quantity" onclick="openEditModal(${JSON.stringify(p).replace(/"/g, '&quot;')})">QUANTITÃ‰: ${p.quantity}</span>
                </div>
            </div>
            <div class="card-footer">
                <button class="edit-btn" onclick="openEditModal(${JSON.stringify(p).replace(/"/g, '&quot;')})">âœï¸</button>
                <button class="delete-btn" onclick="deleteProduct(${p.id})">X</button>
            </div>
        `;
        container.appendChild(card);
    });
}

// ==== Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„Ø© PDF - Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† ØµÙØ­Ø© Ø§Ù„Ø¨Ø­Ø« Ù…Ø¹Ø±ÙˆØ¶Ø© ====
document.getElementById('downloadPDF').addEventListener('click', async () => {
    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† ØµÙØ­Ø© Ø§Ù„Ø¨Ø­Ø« Ù…Ø¹Ø±ÙˆØ¶Ø© Ù‚Ø¨Ù„ Ø¥Ù†Ø´Ø§Ø¡ PDF
    if (searchPage.style.display === 'none') {
        showCustomAlert("PDF", "Veuillez d'abord effectuer une recherche pour gÃ©nÃ©rer un PDF");
        return;
    }
    // Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† generatePDFØŒ Ù†ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
    showDownloadShareModalSearch('download');
});

document.getElementById('sharePDF').addEventListener('click', async () => {
    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† ØµÙØ­Ø© Ø§Ù„Ø¨Ø­Ø« Ù…Ø¹Ø±ÙˆØ¶Ø© Ù‚Ø¨Ù„ Ø¥Ù†Ø´Ø§Ø¡ PDF
    if (searchPage.style.display === 'none') {
        showCustomAlert("PDF", "Veuillez d'abord effectuer une recherche pour gÃ©nÃ©rer un PDF");
        return;
    }
    // Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† generatePDFØŒ Ù†ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
    showDownloadShareModalSearch('share');
});

// ==== Ù†Ø§ÙØ°Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ù„ØµÙØ­Ø© Ø§Ù„Ø¨Ø­Ø« ====
function showDownloadShareModalSearch(action) {
    currentDownloadShareAction = action;
    const modal = document.getElementById('downloadShareModalSearch');
    const title = document.getElementById('downloadShareTitleSearch');
    const options = document.querySelectorAll('#downloadShareModalSearch .download-share-option-search');
    
    // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø­Ø³Ø¨ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡
    title.textContent = action === 'download' ? 'TELECHARGER' : 'PARTAGER';
    
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª
    options.forEach(option => {
        option.classList.remove('selected');
    });
    
    modal.style.display = 'flex';
    
    // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ù„Ø®ÙŠØ§Ø±Ø§Øª
    options.forEach(option => {
        option.onclick = function() {
            options.forEach(opt => opt.classList.remove('selected'));
            this.classList.add('selected');
        };
    });
    
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ù„Ø£Ø²Ø±Ø§Ø±
    document.getElementById('downloadShareCancelBtnSearch').onclick = function() {
        modal.style.display = 'none';
    };
    
    document.getElementById('downloadShareOkBtnSearch').onclick = function() {
        const selectedOption = document.querySelector('#downloadShareModalSearch .download-share-option-search.selected');
        if (!selectedOption) {
            showCustomAlert("SÃ‰LECTION", "Veuillez sÃ©lectionner un format");
            return;
        }
        
        const option = selectedOption.dataset.option; // 'pdf' Ø£Ùˆ 'excel'
        modal.style.display = 'none';
        
        // ØªÙ†ÙÙŠØ° Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
        if (option === 'pdf') {
            // Ø¥Ø°Ø§ ÙƒØ§Ù† PDFØŒ Ù†Ø³ØªØ®Ø¯Ù… generatePDF Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            generatePDF(action); // action Ù‡Ùˆ 'download' Ø£Ùˆ 'share'
        } else if (option === 'excel') {
            // Ø¥Ø°Ø§ ÙƒØ§Ù† EXCELØŒ Ù†Ø³ØªØ®Ø¯Ù… Ø¯ÙˆØ§Ù„ Ø¬Ø¯ÙŠØ¯Ø© Ø³Ù†Ù†Ø´Ø¦Ù‡Ø§ Ù„Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ searchResults
            if (action === 'download') {
                downloadXLSXFromSearch();
            } else {
                shareXLSXFromSearch();
            }
        }
    };
}

// Ù…Ø¹Ø§Ù„Ø¬ ØªØ­Ù…ÙŠÙ„ XLSX Ù…Ù† Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«
function downloadXLSXFromSearch() {
    if (searchResults.length === 0) {
        showCustomAlert("TELECHARGEMENT", "AUCUN PRODUIT Ã€ TELECHARGER!");
        return;
    }

    // ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† Ø§Ù„Ø£Ù‚Ø±Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø¨Ø¹Ø¯
    const productsToExport = sortProductsByExpiry(searchResults);

    const ws = XLSX.utils.json_to_sheet(productsToExport.map(p => ({
        Code: p.code,
        Nom: p.name,
        Date: p.expiry,
        QuantitÃ©: p.quantity
    })));

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Produits");

    const wbout = XLSX.write(wb, { bookType: "xlsx", type: "array" });
    const blob = new Blob([wbout], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
    const url = URL.createObjectURL(blob);

    window.location.href = url;
}

// Ù…Ø¹Ø§Ù„Ø¬ Ù…Ø´Ø§Ø±ÙƒØ© XLSX Ù…Ù† Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«
async function shareXLSXFromSearch() {
    if (searchResults.length === 0) {
        showCustomAlert("PARTAGE", "AUCUN PRODUIT Ã€ PARTAGER!");
        return;
    }

    try {
        // ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† Ø§Ù„Ø£Ù‚Ø±Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø¨Ø¹Ø¯
        const productsToExport = sortProductsByExpiry(searchResults);

        const ws = XLSX.utils.json_to_sheet(productsToExport.map(p => ({
            Code: p.code,
            Nom: p.name,
            Date: p.expiry,
            QuantitÃ©: p.quantity,
            "Jours Restants": daysLeft(p.expiry)
        })));

        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Produits DLC");

        const wbout = XLSX.write(wb, { bookType: "xlsx", type: "array" });
        const blob = new Blob([wbout], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });

        if (navigator.share) {
            try {
                const file = new File([blob], "Recherche_DLC.xlsx", { 
                    type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" 
                });
                
                await navigator.share({
                    type: "file",
                    url: URL.createObjectURL(blob),
                    extension: "xlsx",
                    text: `ğŸ“‹ RECHERCHE DLC - Liste des Produits\n${productsToExport.length} produits\n${document.getElementById('searchResultsTitle').textContent}`
                });
                
                showSuccessMessage("Fichier partagÃ© avec succÃ¨s!");
                return;
                
            } catch (shareError) {
                console.log('Web Share API failed:', shareError);
            }
        }

        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = "Recherche_DLC.xlsx";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showSuccessMessage("Fichier tÃ©lÃ©chargÃ©! Vous pouvez maintenant le partager manuellement.");
        
    } catch (err) {
        console.error('Erreur de partage:', err);
        showCustomAlert("ERREUR", "Erreur lors du partage du fichier: " + err.message);
    }
}

// ==== Ø¥ØµÙ„Ø§Ø­ ÙƒØ§Ù…Ù„ Ù„Ù…Ø´ÙƒÙ„Ø© PDF - Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ ÙÙ‚Ø· ====
async function generatePDF(action = 'download') {
    if (searchResults.length === 0) {
        showCustomAlert("EXPORT PDF", "Aucun rÃ©sultat Ã  exporter");
        return;
    }
    
    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        const margin = 10;
        const tableWidth = pageWidth - 2 * margin;
        
        // ==== ØªØ­Ø³ÙŠÙ† ØªØµÙ…ÙŠÙ… PDF ====
        // Ø§Ù„Ø£Ù„ÙˆØ§Ù†
        const primaryColor = [26, 35, 126]; // Bleu marine
        const secondaryColor = [52, 152, 219]; // Bleu
        const successColor = [46, 204, 113]; // Vert
        const warningColor = [230, 126, 34]; // Orange
        const dangerColor = [231, 76, 60]; // Rouge
        const darkColor = [44, 62, 80]; // Gris foncÃ©
        const lightColor = [248, 249, 250]; // Gris clair
        
        // ==== Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙ‚Ø±ÙŠØ± ====
        const searchTitle = document.getElementById('searchResultsTitle').textContent;
        let searchType = '';
        let searchValue = '';
        
        if (searchTitle.includes('RÃ‰SULTATS POUR:')) {
            searchValue = searchTitle.replace('RÃ‰SULTATS POUR: ', '');
            
            if (searchValue.includes('/') && searchValue.split('/').length === 3) {
                searchType = 'JOUR';
                const [day, month, year] = searchValue.split('/');
                searchValue = `${day}-${month}-${year}`;
            } else if (searchValue.includes('/') && searchValue.split('/').length === 2) {
                searchType = 'MOIS';
                const [month, year] = searchValue.split('/');
                searchValue = `${month}-${year}`;
            } else {
                searchType = 'RECHERCHE';
            }
        } else {
            searchType = 'RECHERCHE';
            searchValue = searchTitle.replace('RÃ‰SULTATS DE RECHERCHE', '');
        }
        
        // ==== Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙ‚Ø±ÙŠØ± ====
        const infoY = 35;
        
        // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„Ø±Ø§ÙŠÙˆÙ†
        const userName = document.getElementById('userNameInput').value || 'Non spÃ©cifiÃ©';
        const rayon = document.getElementById('rayonSelect').value || 'Non spÃ©cifiÃ©';
        
        // ==== ØªØ±ØªÙŠØ¨ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù…Ù† Ø§Ù„Ø£Ù‚Ø±Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø¨Ø¹Ø¯ ====
        const sortedResults = sortProductsByExpiry(searchResults);
        
        // ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø¥Ø±ØªÙØ§Ø¹ Ø±Ø£Ø³ Ø§Ù„Ø¬Ø¯ÙˆÙ„ 12mm ====
        const headerRowHeight = 12; // ØªØºÙŠÙŠØ± Ù…Ù† 25 Ø¥Ù„Ù‰ 12
        const rowHeight = 25; // Ø§Ø±ØªÙØ§Ø¹ ØµÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙŠØ¨Ù‚Ù‰ 25
        
        // Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„ØµÙÙˆÙ Ø§Ù„ØªÙŠ ÙŠÙ…ÙƒÙ† ÙˆØ¶Ø¹Ù‡Ø§ ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„ÙˆØ§Ø­Ø¯Ø©
        const rowsPerPageFirst = Math.floor((pageHeight - infoY - 55) / rowHeight); // Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¹Ù†Ø§ÙˆÙŠÙ†
        const rowsPerPageOther = Math.floor((pageHeight - margin - 20) / rowHeight); // Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰ ÙÙ‚Ø· Ø¨ÙŠØ§Ù†Ø§Øª
        const totalPages = Math.ceil((sortedResults.length - rowsPerPageFirst) / rowsPerPageOther) + 1;
        
        // ==== Ø¥ØµÙ„Ø§Ø­ ÙƒØ§Ù…Ù„: Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø­Ù„Ù‚Ø© Ø¨Ø³ÙŠØ·Ø© Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙØ­Ø§Øª ====
        let currentPage = 1;
        let startIndex = 0;
        
        while (startIndex < sortedResults.length) {
            // Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ØŒ Ø£Ø¶Ù ØµÙØ­Ø© Ø¬Ø¯ÙŠØ¯Ø©
            if (currentPage > 1) {
                doc.addPage();
            }
            
            // ØªØ­Ø¯ÙŠØ¯ Ø¹Ø¯Ø¯ Ø§Ù„ØµÙÙˆÙ ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            let rowsInCurrentPage = currentPage === 1 ? rowsPerPageFirst : rowsPerPageOther;
            let endIndex = Math.min(startIndex + rowsInCurrentPage, sortedResults.length);
            // ==== Ø±Ø³Ù… Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† ÙˆØ§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙÙ‚Ø· ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ ====
            if (currentPage === 1) {
                // ==== Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø© ====
                doc.setFillColor(...primaryColor);
                doc.roundedRect(margin, 10, pageWidth - 2 * margin, 18, 3, 3, 'F');
                
                // Ø´Ø¹Ø§Ø± - ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 2: ØªØºÙŠÙŠØ± Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù…Ù† SUIVI DLC Ø¥Ù„Ù‰ SUIVI DLC PRO ====
                doc.setFontSize(16);
                doc.setTextColor(255, 255, 255);
                doc.setFont(undefined, 'bold');
                doc.text('SUIVI DLC PRO', pageWidth / 2, 20, { align: 'center' });
                
                // ==== Ø­Ù‚Ù„ Ø¹Ù†ÙˆØ§Ù† MOIS / ANNÃ‰E ÙˆØ­Ù‚Ù„ NOMBRE DES PRODUITS ÙÙŠ Ø³Ø·Ø± ÙˆØ§Ø­Ø¯ ====
                doc.setFillColor(...secondaryColor);
                doc.roundedRect(margin, infoY, pageWidth - 2 * margin, 12, 2, 2, 'F');
                // ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: ØªÙƒØ¨ÙŠØ± Ø­Ø¬Ù… Ø§Ù„Ø®Ø· Ø¥Ù„Ù‰ 14 Ù†Ù‚Ø·Ø© ====
                doc.setFontSize(14);
                doc.setTextColor(255, 255, 255);
                
                const leftText = `MOIS / ANNÃ‰E: ${searchValue}`;
                const rightText = `NOMBRE DES PRODUITS: ${searchResults.length}`;
                
                doc.text(leftText, margin + 10, infoY + 7, { align: 'left' });
                doc.text(rightText, pageWidth - margin - 10, infoY + 7, { align: 'right' });
                
                // ==== Ø­Ù‚Ù„ Ø¹Ù†ÙˆØ§Ù† NOM D'EMPLOYÃ‰ ÙˆØ­Ù‚Ù„ RAYON ÙÙŠ Ø³Ø·Ø± ÙˆØ§Ø­Ø¯ ====
                doc.setFillColor(...successColor);
                doc.roundedRect(margin, infoY + 15, pageWidth - 2 * margin, 12, 2, 2, 'F');
                // ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: ØªÙƒØ¨ÙŠØ± Ø­Ø¬Ù… Ø§Ù„Ø®Ø· Ø¥Ù„Ù‰ 14 Ù†Ù‚Ø·Ø© ====
                doc.setFontSize(14);
                doc.setTextColor(255, 255, 255);
                
                const nomText = `NOM D'EMPLOYÃ‰: ${userName}`;
                const rayonText = `RAYON: ${rayon}`;
                
                doc.text(nomText, margin + 10, infoY + 22, { align: 'left' });
                doc.text(rayonText, pageWidth - margin - 10, infoY + 22, { align: 'right' });
                
                // ==== Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª - Ø±Ø£Ø³ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙÙ‚Ø· ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ ====
                const tableTop = infoY + 35;
                
                // Ø±Ø£Ø³ Ø§Ù„Ø¬Ø¯ÙˆÙ„
                doc.setFillColor(...primaryColor);
                doc.roundedRect(margin, tableTop, tableWidth, headerRowHeight, 2, 2, 'F'); // ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø¥Ø±ØªÙØ§Ø¹ 12mm ====
                
                // ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: ØªÙƒØ¨ÙŠØ± Ø­Ø¬Ù… Ø§Ù„Ø®Ø· Ø¥Ù„Ù‰ 14 Ù†Ù‚Ø·Ø© ====
                doc.setFontSize(14);
                doc.setTextColor(255, 255, 255);
                doc.setFont(undefined, 'bold');
                
                // ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: ØªØºÙŠÙŠØ± Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø­Ø³Ø¨ Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª ====
                const colWidths = [25, 40, 60, 25, 25]; // [IMAGE:25mm, CODE:40mm, NOM:60mm, DATE:25mm, QTE:25mm]
                
                let xPos = margin;
                const headers = ['IMAGE', 'CODE', 'NOM', 'DATE', 'QTE'];
                
                headers.forEach((header, index) => {
                    doc.text(header, xPos + colWidths[index] / 2, tableTop + headerRowHeight / 2, { 
                        align: 'center', 
                        baseline: 'middle' 
                    });
                    xPos += colWidths[index];
                });
                
                // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
                let yPos = tableTop + headerRowHeight;
                
                for (let i = startIndex; i < endIndex; i++) {
                    const product = sortedResults[i];
                    const rowIndex = i - startIndex;
                    drawProductRow(doc, product, yPos, margin, colWidths, rowHeight, rowIndex);
                    yPos += rowHeight;
                }
            } else {
                // ==== Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰ - Ø¨ÙŠØ§Ù†Ø§Øª ÙÙ‚Ø· Ø¨Ø¯ÙˆÙ† Ø¹Ù†Ø§ÙˆÙŠÙ† ====
                let yPos = margin + 10; // Ø¨Ø¯Ø§ÙŠØ© Ù…Ù† Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø©
                
                for (let i = startIndex; i < endIndex; i++) {
                    const product = sortedResults[i];
                    const rowIndex = i - startIndex;
                    const colWidths = [25, 40, 60, 25, 25]; // ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø¹Ø±Ø¶ Ø¹Ù…ÙˆØ¯ Ø§Ù„ØµÙˆØ±Ø© 25mm ====
                    drawProductRow(doc, product, yPos, margin, colWidths, rowHeight, rowIndex);
                    yPos += rowHeight;
                }
            }
            
            // ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø¥Ø¶Ø§ÙØ© DÃ‰VELOPPÃ‰ PAR ALA EDDINE ABDELLAOUI ÙÙŠ Ø§Ù„ØªØ°ÙŠÙŠÙ„ Ø¹Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø± ====
            const footerY = pageHeight - 10;
            doc.setFontSize(8);
            doc.setTextColor(150, 150, 150);
            
            // Ø§Ù„Ù†Øµ Ø¹Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø±
            doc.text('DÃ‰VELOPPÃ‰ PAR ALA EDDINE ABDELLAOUI', margin, footerY, { align: 'left' });
            
            // Ø±Ù‚Ù… Ø§Ù„ØµÙØ­Ø© ÙÙŠ Ø§Ù„Ù…Ù†ØªØµÙ
            doc.text(`${currentPage}/${totalPages}`, pageWidth / 2, footerY, { align: 'center' });
            
            // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©
            startIndex = endIndex;
            currentPage++;
        }
        
        if (action === 'download') {
            const fileName = `Rapport_DLC_${searchType.replace(/ /g, '_')}_${new Date().toISOString().slice(0, 10)}.pdf`;
            doc.save(fileName);
            showSuccessMessage('PDF tÃ©lÃ©chargÃ© avec succÃ¨s!');
        } else {
            const pdfBlob = doc.output('blob');
            await sharePDF(pdfBlob);
        }
        
    } catch (error) {
        console.error('Erreur gÃ©nÃ©ration PDF:', error);
        showCustomAlert("ERREUR", "Erreur lors de la gÃ©nÃ©ration du PDF: " + error.message);
    }
}

// ==== Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø±Ø³Ù… ØµÙ Ø§Ù„Ù…Ù†ØªØ¬ ====
function drawProductRow(doc, product, yPos, margin, colWidths, rowHeight, rowIndex) {
    let xPos = margin;
    
    // ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: ØªÙ†Ø§ÙˆØ¨ Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø£Ø³Ø·Ø± ====
    const rowColor = rowIndex % 2 === 0 ? [255, 255, 255] : [240, 240, 240];
    doc.setFillColor(...rowColor);
    doc.rect(margin, yPos, doc.internal.pageSize.getWidth() - 2 * margin, rowHeight, 'F');
    
    // Ø§Ù„ØµÙˆØ±Ø© - ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© 20x20 ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø¹Ù…ÙˆØ¯ 25mm ====
    if (product.img) {
        try {
            const imgData = product.img;
            // ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© 20x20 ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø¹Ù…ÙˆØ¯ 25mm ====
            doc.addImage(imgData, 'JPEG', xPos + 2, yPos + 2, 20, 20); // ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ 20x20
        } catch (imgError) {
            console.log('Error adding image:', imgError);
        }
    }
    xPos += colWidths[0];
    
    // Ø±Ù…Ø² Ø§Ù„Ù…Ù†ØªØ¬
    doc.setTextColor(0, 0, 0);
    doc.setFont(undefined, 'bold');
    // ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: ØªÙƒØ¨ÙŠØ± Ø§Ù„Ø®Ø· Ø¥Ù„Ù‰ 14 Ù†Ù‚Ø·Ø© ====
    doc.setFontSize(14);
    const codeText = doc.splitTextToSize(product.code, colWidths[1] - 4);
    doc.text(codeText, xPos + colWidths[1] / 2, yPos + rowHeight / 2, { 
        align: 'center', 
        baseline: 'middle' 
    });
    xPos += colWidths[1];
    
    // Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬
    doc.setFont(undefined, 'bold'); // ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø¬Ø¹Ù„ Ø§Ù„Ø®Ø· ØºØ§Ù…Ù‚ ====
    // ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: ØªÙƒØ¨ÙŠØ± Ø§Ù„Ø®Ø· Ø¥Ù„Ù‰ 14 Ù†Ù‚Ø·Ø© ====
    doc.setFontSize(14);
    const nameLines = doc.splitTextToSize(product.name, colWidths[2] - 4);
    
    // ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰ Ø£ÙÙ‚ÙŠØ§Ù‹ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† ÙˆØ³Ø·Ù‡ Ø¹Ù…ÙˆØ¯ÙŠØ§Ù‹ ====
    // Ø­Ø³Ø§Ø¨ Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ù†Øµ Ù„Ù…Ø±ÙƒØ²ØªÙ‡ Ø¹Ù…ÙˆØ¯ÙŠØ§Ù‹
    const lineHeight = 5; // Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø³Ø·Ø± Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠ
    const totalTextHeight = nameLines.length * lineHeight;
    const textStartY = yPos + (rowHeight - totalTextHeight) / 2 + lineHeight;
    
    // ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰ Ø£ÙÙ‚ÙŠØ§Ù‹ ====
    // Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø¹Ù…ÙˆØ¯ÙŠØŒ Ù†Ø¶Ø¹Ù‡ ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù…Ø¹ Ù…Ø³Ø§ÙØ© ØµØºÙŠØ±Ø© Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰
    const topMargin = 3; // Ù…Ø³Ø§ÙØ© ØµØºÙŠØ±Ø© Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰
    const topTextStartY = yPos + topMargin + lineHeight;
    
    // Ø±Ø³Ù… ÙƒÙ„ Ø³Ø·Ø± Ù…Ù† Ø§Ù„Ù†Øµ ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰
    nameLines.forEach((line, lineIndex) => {
        doc.text(line, xPos + colWidths[2] / 2, topTextStartY + (lineIndex * lineHeight), { 
            align: 'center', 
            baseline: 'top'
        });
    });
    xPos += colWidths[2];
    
    // ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
    doc.setFont(undefined, 'bold');
    // ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: ØªÙƒØ¨ÙŠØ± Ø§Ù„Ø®Ø· Ø¥Ù„Ù‰ 14 Ù†Ù‚Ø·Ø© ====
    doc.setFontSize(14);
    doc.text(product.expiry, xPos + colWidths[3] / 2, yPos + rowHeight / 2, { 
        align: 'center', 
        baseline: 'middle' 
    });
    xPos += colWidths[3];
    
    // Ø§Ù„ÙƒÙ…ÙŠØ©
    // ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: ØªÙƒØ¨ÙŠØ± Ø§Ù„Ø®Ø· Ø¥Ù„Ù‰ 14 Ù†Ù‚Ø·Ø© ====
    doc.setFontSize(14);
    doc.setTextColor(0, 0, 0);
    doc.text(product.quantity.toString(), xPos + colWidths[4] / 2, yPos + rowHeight / 2, { 
        align: 'center', 
        baseline: 'middle' 
    });
}

// Ù…Ø´Ø§Ø±ÙƒØ© PDF
async function sharePDF(pdfBlob) {
    try {
        if (navigator.share) {
            const file = new File([pdfBlob], "Recherche_DLC.pdf", { 
                type: "application/pdf" 
            });
            
            await navigator.share({
                type: "file",
                url: URL.createObjectURL(pdfBlob),
                extension: "pdf",
                text: `ğŸ“‹ RECHERCHE DLC - ${searchResults.length} produits trouvÃ©s\n${document.getElementById('searchResultsTitle').textContent}`
            });
            
            showSuccessMessage("PDF partagÃ© avec succÃ¨s!");
        } else {
            const url = URL.createObjectURL(pdfBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = "Recherche_DLC.pdf";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showSuccessMessage("PDF tÃ©lÃ©chargÃ©! Vous pouvez maintenant le partager manuellement.");
        }
    } catch (err) {
        console.error('Erreur partage PDF:', err);
        showCustomAlert("ERREUR", "Erreur lors du partage du PDF");
    }
}

// ==== INDEXEDDB ====
const DB_NAME = 'ProduitsDLC';
const DB_VERSION = 2; // ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø²ÙŠØ§Ø¯Ø© Ø±Ù‚Ù… Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ù„ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ====
const STORE_NAME = 'products';
const IMAGES_STORE_NAME = 'productImages'; // ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: ØªØ®Ø²ÙŠÙ† Ø§Ù„ØµÙˆØ± Ø¨Ø´ÙƒÙ„ Ù…Ù†ÙØµÙ„ ====

function openDatabase() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        
        request.onerror = () => reject(request.error);
        request.onsuccess = () => resolve(request.result);
        
        request.onupgradeneeded = (event) => {
            const db = event.target.result;
            if (!db.objectStoreNames.contains(STORE_NAME)) {
                const store = db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                store.createIndex('code', 'code', { unique: false });
                store.createIndex('expiry', 'expiry', { unique: false });
            }
            
            // ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø®Ø²Ù† Ø¬Ø¯ÙŠØ¯ Ù„Ù„ØµÙˆØ± ====
            if (!db.objectStoreNames.contains(IMAGES_STORE_NAME)) {
                const imagesStore = db.createObjectStore(IMAGES_STORE_NAME, { keyPath: 'code' });
            }
        };
    });
}

// ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø¯Ø§Ù„Ø© Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ± Ù…Ù† IndexedDB ====
async function loadProductImages() {
    try {
        if (!db) db = await openDatabase();
        
        return new Promise((resolve, reject) => {
            const transaction = db.transaction([IMAGES_STORE_NAME], 'readonly');
            const store = transaction.objectStore(IMAGES_STORE_NAME);
            const request = store.getAll();
            
            request.onsuccess = () => {
                const loadedImages = request.result;
                loadedImages.forEach(item => {
                    productImages[item.code] = item.img;
                });
                resolve(productImages);
            };
            request.onerror = () => reject(request.error);
        });
    } catch (error) {
        console.error('Error loading product images:', error);
        return {};
    }
}

// ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø¯Ø§Ù„Ø© Ù„Ø­ÙØ¸ Ø§Ù„ØµÙˆØ± ÙÙŠ IndexedDB ====
async function saveProductImage(code, imgData) {
    try {
        if (!db) db = await openDatabase();
        
        return new Promise((resolve, reject) => {
            const transaction = db.transaction([IMAGES_STORE_NAME], 'readwrite');
            const store = transaction.objectStore(IMAGES_STORE_NAME);
            const request = store.put({ code, img: imgData });
            
            request.onsuccess = () => {
                productImages[code] = imgData;
                resolve(request.result);
            };
            request.onerror = () => reject(request.error);
        });
    } catch (error) {
        console.error('Error saving product image:', error);
    }
}

// ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø¯Ø§Ù„Ø© Ù„Ø­Ø°Ù Ø§Ù„ØµÙˆØ± Ù…Ù† IndexedDB ====
async function deleteProductImage(code) {
    try {
        if (!db) db = await openDatabase();
        
        return new Promise((resolve, reject) => {
            const transaction = db.transaction([IMAGES_STORE_NAME], 'readwrite');
            const store = transaction.objectStore(IMAGES_STORE_NAME);
            const request = store.delete(code);
            
            request.onsuccess = () => {
                delete productImages[code];
                resolve();
            };
            request.onerror = () => reject(request.error);
        });
    } catch (error) {
        console.error('Error deleting product image:', error);
    }
}

// ==== Ø§Ù„ØªØµØ­ÙŠØ­: ØªØ­Ø³ÙŠÙ† Ø¯Ø§Ù„Ø© loadProducts Ù„ØªÙØ§Ø¯ÙŠ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ ====
async function loadProducts() {
    try {
        if (!db) db = await openDatabase();
        
        return new Promise((resolve, reject) => {
            const transaction = db.transaction([STORE_NAME], 'readonly');
            const store = transaction.objectStore(STORE_NAME);
            const request = store.getAll();
            
            request.onsuccess = () => {
                const loadedProducts = request.result;
                
                // ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 3: Ø±Ø¨Ø· Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…Ø®Ø²Ù†Ø© Ù…Ø¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ====
                loadedProducts.forEach(product => {
                    if (product.code && productImages[product.code]) {
                        product.img = productImages[product.code];
                    }
                });
                resolve(loadedProducts);
            };
            request.onerror = () => reject(request.error);
        });
    } catch (error) {
        console.error('Error loading products:', error);
        showCustomAlert("ERREUR", "Erreur lors du chargement des produits: " + error.message);
        return [];
    }
}

async function saveProduct(product) {
    if (!db) db = await openDatabase();
    
    return new Promise((resolve, reject) => {
        const transaction = db.transaction([STORE_NAME], 'readwrite');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.add(product);
        
        request.onsuccess = () => {
            // Ø¥ØµÙ„Ø§Ø­: Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ù†ØªØ¬ Ø¥Ù„Ù‰ Ø§Ù„ÙƒØ§Ø¦Ù† Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸
            product.id = request.result;
            // ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 2: ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ±Ø© ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø®Ø²Ù†Ø© ====
            if (product.img && product.code) {
                saveProductImage(product.code, product.img);
            }
            resolve(request.result);
        };
        request.onerror = () => reject(request.error);
    });
}

async function updateProduct(product) {
    if (!db) db = await openDatabase();
    
    return new Promise((resolve, reject) => {
        const transaction = db.transaction([STORE_NAME], 'readwrite');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.put(product);
        
        request.onsuccess = () => {
            // ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 2: ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ±Ø© ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø®Ø²Ù†Ø© ====
            if (product.img && product.code) {
                saveProductImage(product.code, product.img);
            }
            resolve(request.result);
        };
        request.onerror = () => reject(request.error);
    });
}

async function deleteProductById(id) {
    if (!db) db = await openDatabase();
    
    return new Promise((resolve, reject) => {
        const transaction = db.transaction([STORE_NAME], 'readwrite');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.delete(id);
        
        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
    });
}

async function updateStorageInfo() {
    const storageInfo = document.getElementById('storageInfo');
    const products = await loadProducts();
    
    const estimatedSize = products.length * 30;
    const maxSize = 50000;
    
    const percentage = Math.min((estimatedSize / maxSize) * 100, 100);
    const status = percentage < 80 ? 'âœ…' : percentage < 95 ? 'âš ï¸' : 'ğŸ”´';
    
    storageInfo.innerHTML = 
        `${status} Stockage: ${products.length} produits (${Math.round(percentage)}% utilisÃ©) | 
        CapacitÃ©: 1000+ produits avec photos`;
}

// ==== LOAD GOOGLE SHEET CSV ====
const url = "https://docs.google.com/spreadsheets/d/1r0QSoLDzekCfgkZxJ6UlbCpfKf6X57-woxeQDCjNjzU/export?format=csv";

function loadDatabase() {
    Papa.parse(url, { 
        download: true, 
        header: true, 
        complete: results => { 
            database = results.data; 
            // ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 2: ØªØ­Ø¯ÙŠØ« Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ====
            updateProductNames();
        } 
    });
}

// ==== ØªØ­Ø¯ÙŠØ« Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ====
function updateProductNames() {
    // ØªØ­Ø¯ÙŠØ« Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
    products.forEach(product => {
        const dbProduct = database.find(item => (item.Code || "").trim().toLowerCase() === product.code.toLowerCase());
        if (dbProduct && dbProduct.Nom) {
            const newName = dbProduct.Nom.trim().toUpperCase();
            if (product.name !== newName) {
                product.name = newName;
                // ØªØ­Ø¯ÙŠØ« ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
                updateProduct(product);
            }
        }
    });
    
    // ØªØ­Ø¯ÙŠØ« Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ ØµÙØ­Ø© CASSE FRAIS
    casseFraisProducts.forEach(product => {
        const dbProduct = database.find(item => (item.Code || "").trim().toLowerCase() === product.code.toLowerCase());
        if (dbProduct && dbProduct.Nom) {
            const newName = dbProduct.Nom.trim().toUpperCase();
            if (product.name !== newName) {
                product.name = newName;
            }
        }
    });
    
    // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
    renderCards();
    renderCasseFraisCards();
}

// ==== ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ====
async function initApp() {
    try {
        // ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 4: ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Google Sheet Ø¹Ù†Ø¯ ÙƒÙ„ Ø¯Ø®ÙˆÙ„ ====
        loadDatabase();
        
        // ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ± Ø£ÙˆÙ„Ø§Ù‹ ====
        await loadProductImages();
        
        // ==== Ø§Ù„ØªØµØ­ÙŠØ­: ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† IndexedDB Ø£ÙˆÙ„Ø§Ù‹ ====
        products = await loadProducts();
        
        // ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 2: ØªØ­Ø¯ÙŠØ« Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ====
        updateProductNames();
        
        loadUserData();
        
        renderCards();
        updateStorageInfo();
        setupScrollToTop();
        
        // ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«
        setTimeout(loadDatabase, 2000);
        
        // ==== ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ====
        initNotificationSystem();
        
    } catch (error) {
        console.error('Error initializing app:', error);
        document.getElementById('storageInfo').innerHTML = 
            'âš ï¸ Mode hors ligne - DonnÃ©es locales uniquement';
    }
}

// ==== Ø¯ÙˆØ§Ù„ Ù„Ø­ÙØ¸ Ùˆ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ====
function saveUserData() {
    const userName = document.getElementById('userNameInput').value;
    const rayon = document.getElementById('rayonSelect').value;
    
    localStorage.setItem('userName', userName);
    localStorage.setItem('rayon', rayon);
}

function loadUserData() {
    const userName = localStorage.getItem('userName');
    const rayon = localStorage.getItem('rayon');
    
    if (userName) {
        document.getElementById('userNameInput').value = userName;
    }
    
    if (rayon) {
        document.getElementById('rayonSelect').value = rayon;
    }
}

// ==== SEARCH PRODUCT BY CODE ====
document.getElementById("codeInput").addEventListener("input", function(){
    this.value = this.value.replace(/[^0-9]/g, '');
    
    if (this.value.length > 13) {
        this.value = this.value.substring(0, 13);
    }
    
    const code = this.value.trim().toLowerCase();
    const product = database.find(item => (item.Code || "").trim().toLowerCase() === code);
    document.getElementById("nameOutput").value = product ? (product.Nom || "").trim().toUpperCase() : "";
    
    // ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 1: Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø®Ø²Ù†Ø© Ù„Ù„Ù…Ù†ØªØ¬ ====
    if (code && productImages[code]) {
        document.getElementById("previewImage").src = productImages[code];
        selectedImageFile = null;
    }
});

// ==== Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© ====
document.getElementById("codeInput").addEventListener("blur", function(){
    const code = this.value.trim();
    if (code) {
        showProductHistory(code);
    }
});

// ==== Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù†Ø¯ Ø§Ù„ØªØºÙŠÙŠØ± ====
document.getElementById("userNameInput").addEventListener("input", saveUserData);
document.getElementById("rayonSelect").addEventListener("change", saveUserData);

// ==== QR CODE SCANNER ====
document.getElementById("scanButton").addEventListener("click", async () => {
    await startScanner();
});

async function startScanner() {
    const scannerOverlay = document.getElementById("scannerOverlay");
    const scannerFrame = document.getElementById("scannerFrame");
    const scannerLoading = document.getElementById("scannerLoading");
    
    scannerOverlay.style.display = "flex";
    scannerLoading.style.display = "block";
    
    try {
        if (html5QrCode && html5QrCode.isScanning) {
            await html5QrCode.stop();
        }
        
        html5QrCode = new Html5Qrcode("scannerFrame");
        
        const config = {
            fps: 15,
            qrbox: { width: 250, height: 150 },
            aspectRatio: 1.0,
            disableFlip: false
        };
        
        await html5QrCode.start(
            { facingMode: "environment" },
            config,
            onScanSuccess,
            onScanFailure
        );
        
        try {
            await html5QrCode.applyVideoConstraints({
                advanced: [{ torch: true }]
            });
            flashEnabled = true;
            document.getElementById("toggleTorch").textContent = "ğŸ’¡ ON";
        } catch (e) {
            console.log("Flash not supported");
        }
        
        scannerLoading.style.display = "none";
        
    } catch (err) {
        console.error("Error starting scanner:", err);
        scannerOverlay.style.display = "none";
        showCustomAlert("ERREUR CAMÃ‰RA", "Impossible de dÃ©marrer le scanner. VÃ©rifiez les permissions de la camÃ©ra.");
    }
}

function stopScanner() {
    const scannerOverlay = document.getElementById("scannerOverlay");
    
    if (html5QrCode && html5QrCode.isScanning) {
        try {
            html5QrCode.applyVideoConstraints({
                advanced: [{ torch: false }]
            });
            flashEnabled = false;
        } catch (e) {
            console.log("Error turning off flash");
        }
        
        html5QrCode.stop().then(() => {
            scannerOverlay.style.display = "none";
        }).catch(err => {
            console.log("Error stopping scanner:", err);
            scannerOverlay.style.display = "none";
        });
    } else {
        scannerOverlay.style.display = "none";
    }
}

function onScanSuccess(decodedText) {
    let scannedCode = decodedText.trim();
    if (scannedCode.length > 13) {
        scannedCode = scannedCode.substring(0, 13);
    }
    
    document.getElementById("codeInput").value = scannedCode;
    const product = database.find(item => (item.Code || "").trim().toLowerCase() === scannedCode.trim().toLowerCase());
    document.getElementById("nameOutput").value = product ? (product.Nom || "").trim().toUpperCase() : "";
    
    // ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 1: Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø®Ø²Ù†Ø© Ù„Ù„Ù…Ù†ØªØ¬ ====
    if (scannedCode && productImages[scannedCode]) {
        document.getElementById("previewImage").src = productImages[scannedCode];
        selectedImageFile = null;
    }
    
    showSuccessMessage("Code scannÃ© avec succÃ¨s!");
    stopScanner();
    
    setTimeout(() => {
        showProductHistory(scannedCode);
    }, 500);
}

function onScanFailure(error) {
    // Ù„Ø§ ØªÙØ¹Ù„ Ø´ÙŠØ¦Ø§Ù‹ØŒ Ø§Ù„Ù…Ø§Ø³Ø­ Ø³ÙŠØ³ØªÙ…Ø± ÙÙŠ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
}

document.getElementById("closeScanner").addEventListener("click", stopScanner);

// ==== ØªØ¨Ø¯ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„ÙÙ„Ø§Ø´ ====
document.getElementById("toggleTorch").addEventListener("click", async function() {
    if (!html5QrCode || !html5QrCode.isScanning) return;
    
    try {
        flashEnabled = !flashEnabled;
        await html5QrCode.applyVideoConstraints({
            advanced: [{ torch: flashEnabled }]
        });
        this.textContent = flashEnabled ? "ğŸ’¡ ON" : "ğŸ’¡ OFF";
    } catch (e) {
        console.log("Error toggling flash");
    }
});

// ==== ÙˆØ¸Ø§Ø¦Ù ØµÙØ­Ø© CASSE FRAIS ====

// Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù† Ø§Ù„Ù…Ù†ØªØ¬ ÙÙŠ ØµÙØ­Ø© CASSE FRAIS
document.getElementById("casseFraisCodeInput").addEventListener("input", function(){
    this.value = this.value.replace(/[^0-9]/g, '');
    
    if (this.value.length > 13) {
        this.value = this.value.substring(0, 13);
    }
    
    const code = this.value.trim().toLowerCase();
    const product = database.find(item => (item.Code || "").trim().toLowerCase() === code);
    document.getElementById("casseFraisNameOutput").value = product ? (product.Nom || "").trim().toUpperCase() : "";
});

// ==== Ø§Ù„ØªØµØ­ÙŠØ­ Ø§Ù„ÙƒØ§Ù…Ù„: Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¥Ù„Ù‰ CASSE FRAIS Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙƒØ±Ø§Ø± ====
document.getElementById("casseFraisAddButton").addEventListener("click", async () => {
    const code = document.getElementById("casseFraisCodeInput").value.trim();
    const name = document.getElementById("casseFraisNameOutput").value.trim();
    let expiry = document.getElementById("casseFraisExpiryInput").value.trim();
    const quantity = document.getElementById("casseFraisQuantityInput").value; 
    
    expiry = formatDateInput(expiry);
    
    if(!expiry || !isValidDate(expiry)){ 
        showCustomAlert("DATE INVALIDE!", "Veuillez saisir une date valide au format DD/MM/YYYY");
        return; 
    }
    if(!code){ 
        showCustomAlert("CHAMPS MANQUANTS", "Veuillez remplir le code produit!");
        return; 
    }
    
    // ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 3: Ø¥Ø¬Ø¨Ø§Ø± Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒÙ…ÙŠØ© ÙÙŠ ØµÙØ­Ø© CASSE FRAIS ====
    if(!quantity){ 
        showCustomAlert("CHAMPS MANQUANTS", "Veuillez remplir la quantitÃ©!");
        return; 
    }
    
    // ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 1: Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø± ÙÙŠ ØµÙØ­Ø© CASSE FRAIS ====
    const duplicate = casseFraisProducts.find(p => p.code === code && p.expiry === expiry);
    if(duplicate){ 
        showCustomAlert("PRODUIT EXISTANT", "Ce produit a dÃ©jÃ  Ã©tÃ© ajoutÃ©!");
        return; 
    }
    
    const product = {
        code,
        name: name.toUpperCase(),
        expiry,
        quantity: quantity, // ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 3: Ø¥Ø¬Ø¨Ø§Ø± Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒÙ…ÙŠØ© ====
        timestamp: new Date().getTime()
    };
    
    try {
        casseFraisProducts.push(product);
        
        document.getElementById("casseFraisCodeInput").value = "";
        document.getElementById("casseFraisNameOutput").value = "";
        document.getElementById("casseFraisExpiryInput").value = "";
        document.getElementById("casseFraisQuantityInput").value = "";
        
        renderCasseFraisCards();
        showSuccessMessage("Produit ajoutÃ© Ã  Casse Frais avec succÃ¨s!");
    } catch (error) {
        console.error('Error adding product to casse frais:', error);
        showCustomAlert("ERREUR", "Erreur lors de l'ajout du produit");
    }
});

// Ø§Ù„Ù…Ø§Ø³Ø­ Ø§Ù„Ø¶ÙˆØ¦ÙŠ Ù„ØµÙØ­Ø© CASSE FRAIS
document.getElementById("casseFraisScanButton").addEventListener("click", async () => {
    await startCasseFraisScanner();
});

async function startCasseFraisScanner() {
    const scannerOverlay = document.getElementById("casseFraisScannerOverlay");
    const scannerFrame = document.getElementById("casseFraisScannerFrame");
    const scannerLoading = document.getElementById("casseFraisScannerLoading");
    
    scannerOverlay.style.display = "flex";
    scannerLoading.style.display = "block";
    
    try {
        if (casseFraisHtml5QrCode && casseFraisHtml5QrCode.isScanning) {
            await casseFraisHtml5QrCode.stop();
        }
        
        casseFraisHtml5QrCode = new Html5Qrcode("casseFraisScannerFrame");
        
        const config = {
            fps: 15,
            qrbox: { width: 250, height: 150 },
            aspectRatio: 1.0,
            disableFlip: false
        };
        
        await casseFraisHtml5QrCode.start(
            { facingMode: "environment" },
            config,
            onCasseFraisScanSuccess,
            onCasseFraisScanFailure
        );
        
        try {
            await casseFraisHtml5QrCode.applyVideoConstraints({
                advanced: [{ torch: true }]
            });
            flashEnabled = true;
            document.getElementById("casseFraisToggleTorch").textContent = "ğŸ’¡ ON";
        } catch (e) {
            console.log("Flash not supported");
        }
        
        scannerLoading.style.display = "none";
        
    } catch (err) {
        console.error("Error starting casse frais scanner:", err);
        scannerOverlay.style.display = 'none';
        showCustomAlert("ERREUR CAMÃ‰RA", "Impossible de dÃ©marrer le scanner. VÃ©rifiez les permissions de la camÃ©ra.");
    }
}

function stopCasseFraisScanner() {
    const scannerOverlay = document.getElementById("casseFraisScannerOverlay");
    
    if (casseFraisHtml5QrCode && casseFraisHtml5QrCode.isScanning) {
        try {
            casseFraisHtml5QrCode.applyVideoConstraints({
                advanced: [{ torch: false }]
            });
            flashEnabled = false;
        } catch (e) {
            console.log("Error turning off flash");
        }
        
        casseFraisHtml5QrCode.stop().then(() => {
            scannerOverlay.style.display = 'none';
        }).catch(err => {
            console.log("Error stopping casse frais scanner:", err);
            scannerOverlay.style.display = 'none';
        });
    } else {
        scannerOverlay.style.display = 'none';
    }
}

function onCasseFraisScanSuccess(decodedText) {
    let scannedCode = decodedText.trim();
    if (scannedCode.length > 13) {
        scannedCode = scannedCode.substring(0, 13);
    }
    
    document.getElementById("casseFraisCodeInput").value = scannedCode;
    const product = database.find(item => (item.Code || "").trim().toLowerCase() === scannedCode.trim().toLowerCase());
    document.getElementById("casseFraisNameOutput").value = product ? (product.Nom || "").trim().toUpperCase() : "";
    
    showSuccessMessage("Code scannÃ© avec succÃ¨s!");
    stopCasseFraisScanner();
}

function onCasseFraisScanFailure(error) {
    // Ù„Ø§ ØªÙØ¹Ù„ Ø´ÙŠØ¦Ø§Ù‹ØŒ Ø§Ù„Ù…Ø§Ø³Ø­ Ø³ÙŠØ³ØªÙ…Ø± ÙÙŠ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
}

document.getElementById("casseFraisCloseScanner").addEventListener("click", stopCasseFraisScanner);

// ØªØ¨Ø¯ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„ÙÙ„Ø§Ø´ Ù„ØµÙØ­Ø© CASSE FRAIS
document.getElementById("casseFraisToggleTorch").addEventListener("click", async function() {
    if (!casseFraisHtml5QrCode || !casseFraisHtml5QrCode.isScanning) return;
    
    try {
        flashEnabled = !flashEnabled;
        await casseFraisHtml5QrCode.applyVideoConstraints({
            advanced: [{ torch: flashEnabled }]
        });
        this.textContent = flashEnabled ? "ğŸ’¡ ON" : "ğŸ’¡ OFF";
    } catch (e) {
        console.log("Error toggling flash");
    }
});

// ØªÙ†Ø³ÙŠÙ‚ Ø­Ù‚Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙÙŠ ØµÙØ­Ø© CASSE FRAIS
const casseFraisExpiryInput = document.getElementById("casseFraisExpiryInput");
casseFraisExpiryInput.addEventListener("input", function(){
    let val = this.value.replace(/[^0-9]/g,'');
    if(val.length > 2 && val.length <= 4) val = val.slice(0,2) + '/' + val.slice(2);
    else if(val.length > 4) val = val.slice(0,2) + '/' + val.slice(2,4) + '/' + val.slice(4,8);
    this.value = val.slice(0,10);
});

// Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ®
document.getElementById('expiryInput').addEventListener('input', function() {
    autoAdvanceDate(this);
});

document.getElementById('casseFraisExpiryInput').addEventListener('input', function() {
    autoAdvanceDate(this);
});

// Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ø­Ù‚Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙÙŠ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
document.getElementById('editExpiry').addEventListener('input', function() {
    autoAdvanceDate(this);
});

// ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: ØªØ¹Ø±ÙŠÙ Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø¨Ø·Ø§Ù‚Ø§Øª CASSE FRAIS Ù…Ø¹ Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ====
window.renderCasseFraisCards = function() {
    const container = document.getElementById("casseFraisCardsContainer");
    container.innerHTML = "";
    
    const sortedProducts = [...casseFraisProducts].sort((a,b) => {
        const [d1,m1,y1] = a.expiry.split("/").map(Number);
        const [d2,m2,y2] = b.expiry.split("/").map(Number);
        return new Date(y1,m1-1,d1) - new Date(y2,m2-1,d2);
    });
    
    if (sortedProducts.length === 0) {
        container.innerHTML = '<div class="card"><div class="card-content"><div class="card-name">Aucun produit dans Casse Frais</div></div></div>';
        document.getElementById("casseFraisProductCountNumber").textContent = "0";
        return;
    }
    
    sortedProducts.forEach((p, index) => {
        const remaining = daysLeft(p.expiry);
        const color = daysColor(remaining);
        const card = document.createElement("div");
        card.className = "card";
        card.style.borderLeftColor = color;
        card.innerHTML = `
            <div class="card-content">
                <div class="card-header">
                    <span class="days-left" style="background:${color}">${remaining} JOURS RESTANT</span>
                </div>
                <span class="card-code">${p.code}</span>
                <div class="card-name">${p.name}</div>
                <div class="card-details">
                    <span class="card-date">DATE: ${p.expiry}</span>
                    <span class="card-quantity">QUANTITÃ‰: ${p.quantity}</span>
                </div>
            </div>
            <div class="card-footer">
                <button class="edit-btn" onclick="openCasseFraisEditModal(${index})">âœï¸</button>
                <button class="delete-btn" onclick="deleteCasseFraisProduct(${index})">X</button>
            </div>
        `;
        container.appendChild(card);
    });
    
    document.getElementById("casseFraisProductCountNumber").textContent = casseFraisProducts.length;
};

// ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø¯Ø§Ù„Ø© ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ù€ CASSE FRAIS ====
window.openCasseFraisEditModal = function(index) {
    const product = casseFraisProducts[index];
    currentEditingProduct = { index, product: { ...product } };
    
    document.getElementById('editExpiry').value = product.expiry;
    document.getElementById('editQuantity').value = product.quantity;
    document.getElementById('editImage').value = '';
    
    // ØªØºÙŠÙŠØ± Ù†Øµ Ø²Ø± Ø§Ù„Ø­ÙØ¸ Ù„ÙŠØµØ¨Ø­ Ø®Ø§ØµÙ‹Ø§ Ø¨Ù€ CASSE FRAIS
    document.getElementById('saveEditButton').textContent = 'ğŸ’¾ SAUVEGARDER CASSE FRAIS';
    
    document.getElementById('editModal').style.display = 'flex';
};

// ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: ØªØ¹Ø¯ÙŠÙ„ Ù…Ø³ØªÙ…Ø¹ Ø­Ø¯Ø« Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ù€ CASSE FRAIS ====
document.getElementById('saveEditButton').addEventListener('click', async function() {
    const newExpiry = document.getElementById('editExpiry').value;
    const newQuantity = document.getElementById('editQuantity').value;
    const imageFile = document.getElementById('editImage').files[0];
    
    if (!newExpiry || !isValidDate(formatDateInput(newExpiry))) {
        showCustomAlert("DATE INVALIDE!", "Veuillez saisir une date valide au format DD/MM/YYYY");
        return;
    }
    
    try {
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ù€ CASSE FRAIS
        if (currentEditingProduct && currentEditingProduct.index !== undefined) {
            const index = currentEditingProduct.index;
            casseFraisProducts[index].expiry = formatDateInput(newExpiry);
            casseFraisProducts[index].quantity = newQuantity || "";
            
            if (imageFile) {
                resizeImage(imageFile, 400, 400, resizedData => {
                    casseFraisProducts[index].img = resizedData;
                    renderCasseFraisCards();
                    document.getElementById('editModal').style.display = 'none';
                    currentEditingProduct = null;
                    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù†Øµ Ø²Ø± Ø§Ù„Ø­ÙØ¸
                    document.getElementById('saveEditButton').textContent = 'ğŸ’¾ SAUVEGARDER';
                    showSuccessMessage("Produit Casse Frais modifiÃ© avec succÃ¨s!");
                });
            } else {
                renderCasseFraisCards();
                document.getElementById('editModal').style.display = 'none';
                currentEditingProduct = null;
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù†Øµ Ø²Ø± Ø§Ù„Ø­ÙØ¸
                document.getElementById('saveEditButton').textContent = 'ğŸ’¾ SAUVEGARDER';
                showSuccessMessage("Produit Casse Frais modifiÃ© avec succÃ¨s!");
            }
        } else {
            // Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø£ØµÙ„ÙŠ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
            const productIndex = products.findIndex(p => p.id === currentEditingProductId);
            if (productIndex !== -1) {
                products[productIndex].expiry = formatDateInput(newExpiry);
                products[productIndex].quantity = newQuantity || "";
                
                if (imageFile) {
                    resizeImage(imageFile, 400, 400, resizedData => {
                        products[productIndex].img = resizedData;
                        // ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 2: ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø®Ø²Ù†Ø© ====
                        if (products[productIndex].code) {
                            saveProductImage(products[productIndex].code, resizedData);
                        }
                        updateProduct(products[productIndex]).then(() => {
                            renderCards();
                            updateStorageInfo();
                            document.getElementById('editModal').style.display = 'none';
                            currentEditingProductId = null;
                            showSuccessMessage("Produit modifiÃ© avec succÃ¨s!");
                            
                            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
                            setTimeout(checkExpiringProducts, 1000);
                            
                            if (document.getElementById('searchPage').style.display !== 'none') {
                                const dateSearch = document.getElementById('dateSearch').value;
                                const monthSearch = document.getElementById('monthSearch').value;
                                const codeSearch = document.getElementById('codeSearch').value;
                                if (dateSearch || monthSearch || codeSearch) {
                                    document.getElementById('performSearchButton').click();
                                }
                            }
                        });
                    });
                } else {
                    await updateProduct(products[productIndex]);
                    renderCards();
                    updateStorageInfo();
                    document.getElementById('editModal').style.display = 'none';
                    currentEditingProductId = null;
                    showSuccessMessage("Produit modifiÃ© avec succÃ¨s!");
                    
                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
                    setTimeout(checkExpiringProducts, 1000);
                    
                    if (document.getElementById('searchPage').style.display !== 'none') {
                        const dateSearch = document.getElementById('dateSearch').value;
                        const monthSearch = document.getElementById('monthSearch').value;
                        const codeSearch = document.getElementById('codeSearch').value;
                        if (dateSearch || monthSearch || codeSearch) {
                            document.getElementById('performSearchButton').click();
                        }
                    }
                }
            } else {
                showCustomAlert("ERREUR", "Produit non trouvÃ©");
            }
        }
    } catch (error) {
        console.error('Error updating product:', error);
        showCustomAlert("ERREUR", "Erreur lors de la modification du produit");
    }
});

// ==== Ø§Ù„ØªØµØ­ÙŠØ­: ØªØ¹Ø±ÙŠÙ Ø¯Ø§Ù„Ø© Ø­Ø°Ù Ù…Ù†ØªØ¬ Ù…Ù† CASSE FRAIS ÙÙŠ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ ====
window.deleteCasseFraisProduct = function(index) {
    showCustomConfirm(1, function() {
        casseFraisProducts.splice(index, 1);
        renderCasseFraisCards();
        showSuccessMessage("Produit supprimÃ© de Casse Frais avec succÃ¨s!");
    });
};

// ==== Ø²Ø± SUPPRIMER TOUT ====
document.getElementById('deleteAllButton').addEventListener('click', function() {
    if (products.length === 0) {
        showCustomAlert("SUPPRIMER", "AUCUN PRODUIT Ã€ SUPPRIMER!");
        return;
    }
    
    showCustomConfirm(products.length, function() {
        const deletePromises = products.map(product => deleteProductById(product.id));
        
        Promise.all(deletePromises).then(() => {
            products = [];
            renderCards();
            updateStorageInfo();
            showSuccessMessage(`${products.length} produits supprimÃ©s avec succÃ¨s!`);
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„Ø­Ø°Ù
            setTimeout(checkExpiringProducts, 1000);
            
            if (document.getElementById('searchPage').style.display !== 'none') {
                const dateSearch = document.getElementById('dateSearch').value;
                const monthSearch = document.getElementById('monthSearch').value;
                const codeSearch = document.getElementById('codeSearch').value;
                if (dateSearch || monthSearch || codeSearch) {
                    document.getElementById('performSearchButton').click();
                }
            }
        }).catch(error => {
            console.error('Error deleting products:', error);
            showCustomAlert("ERREUR", "Erreur lors de la suppression des produits");
        });
    }, "SUPPRIMER TOUT", `Voulez-vous vraiment supprimer TOUS les ${products.length} produits ?`);
});

// ==== Ø²Ø± SUPPRIMER TOUT ÙÙŠ ØµÙØ­Ø© CASSE FRAIS ====
document.getElementById('casseFraisDeleteAllButton').addEventListener('click', function() {
    if (casseFraisProducts.length === 0) {
        showCustomAlert("SUPPRIMER", "AUCUN PRODUIT Ã€ SUPPRIMER!");
        return;
    }
    
    showCustomConfirm(casseFraisProducts.length, function() {
        casseFraisProducts = [];
        renderCasseFraisCards();
        showSuccessMessage(`${casseFraisProducts.length} produits supprimÃ©s de Casse Frais avec succÃ¨s!`);
    }, "SUPPRIMER TOUT", `Voulez-vous vraiment supprimer TOUS les ${casseFraisProducts.length} produits de Casse Frais ?`);
});

function showSuccessMessage(message) {
    const successMessage = document.getElementById("successMessage");
    successMessage.textContent = message;
    successMessage.style.display = "block";
    
    setTimeout(() => {
        successMessage.style.display = 'none';
    }, 3000);
}

// ==== Ø§Ù„ØªØµØ­ÙŠØ­ Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ® ====
function formatDateInput(input){ 
    if (!input || typeof input !== 'string') return null;
    
    try {
        let parts = input.split('/'); 
        if(parts.length !== 3) return null; 
        
        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡ ÙˆØ¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§ÙØ§Øª
        const day = parts[0].trim().padStart(2, '0');
        const month = parts[1].trim().padStart(2, '0');
        const year = parts[2].trim();
        
        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø³Ù†Ø© ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ 4 Ø£Ø±Ù‚Ø§Ù…
        if (year.length === 2) {
            // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø³Ù†Ø© Ù…ÙƒÙˆÙ†Ø© Ù…Ù† Ø±Ù‚Ù…ÙŠÙ†ØŒ Ø§ÙØªØ±Ø¶ Ø£Ù†Ù‡Ø§ ÙÙŠ Ø§Ù„Ù‚Ø±Ù† 21
            const fullYear = '20' + year;
            return `${day}/${month}/${fullYear}`;
        }
        
        return `${day}/${month}/${year}`; 
    } catch (error) {
        console.error('Error in formatDateInput:', error, input);
        return null;
    }
}

function isValidDate(dateStr){ 
    try {
        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø³Ù„Ø³Ù„Ø© ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ 3 Ø£Ø¬Ø²Ø§Ø¡
        const parts = dateStr.split('/');
        if (parts.length !== 3) return false;
        
        const d = parseInt(parts[0], 10);
        const m = parseInt(parts[1], 10);
        const y = parseInt(parts[2], 10);
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ØµØ§Ù„Ø­Ø©
        if (isNaN(d) || isNaN(m) || isNaN(y)) return false;
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†Ø·Ø§Ù‚Ø§Øª Ø§Ù„ÙŠÙˆÙ… ÙˆØ§Ù„Ø´Ù‡Ø± ÙˆØ§Ù„Ø³Ù†Ø©
        if (d < 1 || d > 31) return false;
        if (m < 1 || m > 12) return false;
        if (y < 2000 || y > 2100) return false;
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ø´Ù‡Ø± Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ 30 ÙŠÙˆÙ…Ù‹Ø§
        if ([4, 6, 9, 11].includes(m) && d > 30) return false;
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø´Ù‡Ø± ÙØ¨Ø±Ø§ÙŠØ± (Ù…Ø¹ Ù…Ø±Ø§Ø¹Ø§Ø© Ø§Ù„Ø³Ù†ÙˆØ§Øª Ø§Ù„ÙƒØ¨ÙŠØ³Ø©)
        if (m === 2) {
            const isLeapYear = (y % 4 === 0 && y % 100 !== 0) || (y % 400 === 0);
            if (isLeapYear && d > 29) return false;
            if (!isLeapYear && d > 28) return false;
        }
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙƒØ§Ø¦Ù† Date
        const date = new Date(y, m - 1, d);
        return date.getFullYear() === y && 
               date.getMonth() === m - 1 && 
               date.getDate() === d;
    } catch (error) {
        console.error('Error in isValidDate:', error, dateStr);
        return false;
    }
}

function daysLeft(expiry){ 
    const [d,m,y] = expiry.split("/").map(Number); 
    const expiryDate = new Date(y,m-1,d); 
    const today = new Date(); 
    return Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24)); 
}

function daysColor(days){ 
    if(days < 0) return "#e74c3c";
    if(days <= 30) return "#f1c40f";
    if(days <= 60) return "#e67e22";
    if(days <= 90) return "#3498db";
    return "#2ecc71";
}

// IMAGE RESIZE
function resizeImage(file, maxWidth, maxHeight, callback){
    const reader = new FileReader();
    reader.onload = function(e){
        const img = new Image();
        img.onload = function(){
            let canvas = document.createElement('canvas'); 
            let ctx = canvas.getContext('2d');
            let width = img.width, height = img.height;
            
            if(width > height){ 
                if(width > maxWidth){ 
                    height = Math.round(height * (maxWidth / width)); 
                    width = maxWidth; 
                } 
            } else { 
                if(height > maxHeight){ 
                    width = Math.round(width * (maxHeight / height)); 
                    height = maxHeight; 
                } 
            }
            
            canvas.width = width; 
            canvas.height = height;
            ctx.drawImage(img, 0, 0, width, height);
            callback(canvas.toDataURL('image/jpeg', 0.7));
        }
        img.src = e.target.result;
    }
    reader.readAsDataURL(file);
}

// STOCK IMAGE
document.getElementById("stockButton").addEventListener("click", () => {
    const input = document.getElementById("imageInput");
    input.click();
    input.onchange = e => {
        if(e.target.files.length > 0){
            selectedImageFile = e.target.files[0];
            const reader = new FileReader();
            reader.onload = evt => { 
                document.getElementById("previewImage").src = evt.target.result; 
            }
            reader.readAsDataURL(selectedImageFile);
        }
    }
});

// ==== Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ====
document.getElementById("cameraButton").addEventListener("click", async () => {
    const overlay = document.getElementById("cameraOverlay");
    const video = document.getElementById("cameraVideo");
    overlay.style.display = "flex";

    let stream = null;
    try {
        stream = await navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: { exact: "environment" } }, 
            audio: false 
        });
        currentStream = stream;
    } catch(err) {
        try { 
            stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
            currentStream = stream;
        } catch(err2) { 
            overlay.style.display = "none"; 
            showCustomAlert("ERREUR CAMÃ‰RA", "Impossible d'accÃ©der Ã  la camÃ©ra: " + err2.message);
            return; 
        }
    }

    video.srcObject = stream;

    document.getElementById("closeCameraButton").onclick = () => {
        stream.getTracks().forEach(track => track.stop());
        overlay.style.display = "none";
        currentStream = null;
    };

    document.getElementById("captureButton").onclick = () => {
        const canvas = document.createElement("canvas");
        canvas.width = video.videoWidth; 
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        canvas.toBlob(blob => {
            selectedImageFile = new File([blob], "camera.jpg", { type: "image/jpeg" });
            resizeImage(selectedImageFile, 400, 400, resizedData => {
                document.getElementById("previewImage").src = resizedData;
            });
        }, "image/jpeg", 0.8);

        stream.getTracks().forEach(track => track.stop());
        overlay.style.display = "none";
        currentStream = null;
    };
});

// ==== Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø¥Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ====
async function addProductToDB(code, name, expiry, quantity, imgData) {
    const product = {
        code,
        name: name.toUpperCase(),
        expiry,
        quantity: quantity || "",
        img: imgData,
        timestamp: new Date().getTime()
    };

    try {
        await saveProduct(product);
        products.push(product);

        // ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 2: ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø®Ø²Ù†Ø© ====
        if (imgData && code) {
            await saveProductImage(code, imgData);
        }

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ù‚ÙˆÙ„
        document.getElementById("codeInput").value = "";
        document.getElementById("nameOutput").value = "";
        document.getElementById("expiryInput").value = "";
        document.getElementById("quantityInput").value = "";
        document.getElementById("previewImage").src = "";
        selectedImageFile = null;

        renderCards();
        updateStorageInfo();
        showSuccessMessage("Produit ajoutÃ© avec succÃ¨s!");
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ©
        setTimeout(checkExpiringProducts, 1000);
    } catch (error) {
        console.error('Error saving product:', error);
        throw error;
    }
}

// ==== Ø§Ù„ØªØµØ­ÙŠØ­ Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ø¯Ø§Ù„Ø© addButton ====
document.getElementById("addButton").addEventListener("click", async () => {
    const code = document.getElementById("codeInput").value.trim();
    const name = document.getElementById("nameOutput").value.trim();
    let expiry = document.getElementById("expiryInput").value.trim();
    const quantity = document.getElementById("quantityInput").value; 

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
    if(!code){ 
        showCustomAlert("CHAMPS MANQUANTS", "Veuillez remplir le code produit!");
        return; 
    }

    expiry = formatDateInput(expiry);
    if(!expiry || !isValidDate(expiry)){ 
        showCustomAlert("DATE INVALIDE!", "Veuillez saisir une date valide au format DD/MM/YYYY");
        return; 
    }

    try {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙƒØ±Ø§Ø± ÙÙŠ Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        const duplicateInMemory = products.find(p => p.code === code && p.expiry === expiry);
        if(duplicateInMemory){ 
            showCustomAlert("PRODUIT EXISTANT", "Ce produit a dÃ©jÃ  Ã©tÃ© ajoutÃ© avec la mÃªme date!");
            return; 
        }

        // ==== Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙƒØ±Ø§Ø± ÙÙŠ IndexedDB ====
        const duplicateInDB = await checkDuplicateInIndexedDB(code, expiry);
        if(duplicateInDB){ 
            showCustomAlert("PRODUIT EXISTANT", "Ce produit existe dÃ©jÃ  dans la base de donnÃ©es avec la mÃªme date!");

            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† IndexedDB Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ØªØ²Ø§Ù…Ù†
            products = await loadProducts();
            renderCards();
            updateStorageInfo();
            return; 
        }

        // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ ØªÙƒØ±Ø§Ø±ØŒ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¥Ø¶Ø§ÙØ©
        let finalImageData = null;
        if (selectedImageFile) {
            resizeImage(selectedImageFile, 400, 400, async (resizedData) => {
                await addProductToDB(code, name, expiry, quantity, resizedData);
            });
        } else if (productImages[code]) {
            finalImageData = productImages[code];
            await addProductToDB(code, name, expiry, quantity, finalImageData);
        } else {
            await addProductToDB(code, name, expiry, quantity, null);
        }

    } catch (error) {
        console.error('Error in add button:', error);
        showCustomAlert("ERREUR", "Erreur lors de l'ajout du produit: " + error.message);
    }
});

// ==== Ø§Ù„ØªØµØ­ÙŠØ­ Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ø¯Ø§Ù„Ø© Ø§Ø³ØªÙŠØ±Ø§Ø¯ Excel - Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„ÙƒÙ…ÙŠØ© ====
document.getElementById("importButton").addEventListener("click", () => {
    const input = document.createElement("input");
    input.type = "file"; 
    input.accept = ".xlsx,.xls,.csv";
    input.onchange = e => {
        const file = e.target.files[0];
        const fileExtension = file.name.split('.').pop().toLowerCase();
        
        if (fileExtension === 'csv') {
            loadCSVFile(file);
        } else {
            // Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Excel
            const reader = new FileReader();
            reader.onload = evt => {
                const data = new Uint8Array(evt.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(sheet);
                
                processImportData(jsonData);
            };
            reader.readAsArrayBuffer(file);
        }
    };
    input.click();
});

// ==== Ø§Ù„ØªØµØ­ÙŠØ­ Ø§Ù„ÙƒØ§Ù…Ù„: Ø¯Ø§Ù„Ø© Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ - Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„ÙƒÙ…ÙŠØ© ====
async function processImportData(jsonData) {
    console.log('DonnÃ©es importÃ©es:', jsonData);
    
    let importedCount = 0;
    let errors = [];
    
    const importPromises = jsonData.map(async (p, index) => {
        try {
            const code = (p.Code || p.CODE || "").toString().trim();
            const name = (p.Nom || p.NOM || p.Name || p.NAME || "").toString().trim();
            let expiry = (p.Date || p.DATE || p.Expiry || p.EXPIRY || "").toString().trim();
            
            // ==== Ø§Ù„ØªØµØ­ÙŠØ­ Ø§Ù„ÙƒØ§Ù…Ù„: Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ÙƒÙ…ÙŠØ© Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ ====
            let quantity = "";
            
            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø­Ù‚Ù„ Ø§Ù„ÙƒÙ…ÙŠØ© Ø¨Ø£ÙŠ Ø§Ø³Ù… Ù…Ø­ØªÙ…Ù„
            const quantityFields = ['QuantitÃ©', 'QUANTITÃ‰', 'Quantity', 'QUANTITY', 'Qte', 'QTE', 'Qte.', 'Quantite', 'quantite', 'Q'];
            
            for (const field of quantityFields) {
                if (p[field] !== undefined && p[field] !== null && p[field] !== "") {
                    quantity = p[field].toString().trim();
                    console.log(`QuantitÃ© trouvÃ©e dans le champ ${field}:`, quantity);
                    break;
                }
            }
            
            // Ø¥Ø°Ø§ Ù„Ù… Ù†Ø¬Ø¯ Ø§Ù„ÙƒÙ…ÙŠØ©ØŒ Ù†Ø¨Ø­Ø« ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„
            if (!quantity) {
                for (const key in p) {
                    if (key.toLowerCase().includes('quant') || key.toLowerCase().includes('qte') || key === 'Q') {
                        if (p[key] !== undefined && p[key] !== null && p[key] !== "") {
                            quantity = p[key].toString().trim();
                            console.log(`QuantitÃ© trouvÃ©e dans le champ ${key}:`, quantity);
                            break;
                        }
                    }
                }
            }
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ÙƒÙ…ÙŠØ© Ø±Ù‚Ù…ÙŠØ©ØŒ Ù†Ø­ÙˆÙ„Ù‡Ø§ Ø¥Ù„Ù‰ Ø¹Ø¯Ø¯ ØµØ­ÙŠØ­
            if (quantity && !isNaN(quantity)) {
                quantity = parseInt(quantity).toString();
            }
            
            console.log(`Traitement produit ${index}:`, { code, expiry, name, quantity });
            
            // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­
            expiry = formatDateInput(expiry);
            
            console.log(`Date formatÃ©e:`, expiry);
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            if (!code) {
                errors.push(`Ligne ${index + 2}: Code manquant`);
                return false;
            }
            
            if (!expiry) {
                errors.push(`Ligne ${index + 2}: Date manquante ou invalide: ${p.Date}`);
                return false;
            }
            
            if (!isValidDate(expiry)) {
                errors.push(`Ligne ${index + 2}: Date invalide: ${expiry} (original: ${p.Date})`);
                return false;
            }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙƒØ±Ø§Ø±
            const duplicateInMemory = products.find(product => 
                product.code === code && product.expiry === expiry);
            
            if (duplicateInMemory) {
                errors.push(`Ligne ${index + 2}: Produit dupliquÃ©: ${code} - ${expiry}`);
                return false;
            }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙƒØ±Ø§Ø± ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            const duplicateInDatabase = await checkDuplicateInIndexedDB(code, expiry);
            if (duplicateInDatabase) {
                errors.push(`Ligne ${index + 2}: Produit existe dÃ©jÃ  en base: ${code} - ${expiry}`);
                return false;
            }
            
            // ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 3: Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø®Ø²Ù†Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø© ====
            const productImg = productImages[code] || null;
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬
            const product = {
                code,
                name: name.toUpperCase(),
                expiry,
                quantity: quantity, // ==== Ø§Ù„ØªØµØ­ÙŠØ­: Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø¹Ø¯Ù„Ø© ====
                img: productImg, // ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 3: Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø®Ø²Ù†Ø© ====
                timestamp: new Date().getTime()
            };
            
            await saveProduct(product);
            products.push(product);
            importedCount++;
            
            console.log(`Produit ${index} importÃ© avec succÃ¨s:`, product);
            return true;
            
        } catch (error) {
            console.error(`Erreur ligne ${index + 2}:`, error);
            errors.push(`Ligne ${index + 2}: Erreur - ${error.message}`);
            return false;
        }
    });
    
    Promise.all(importPromises).then(results => {
        const successfulImports = results.filter(result => result).length;
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ù‚ÙˆÙ„
        document.getElementById("codeInput").value = "";
        document.getElementById("nameOutput").value = "";
        document.getElementById("expiryInput").value = "";
        document.getElementById("quantityInput").value = "";
        document.getElementById("previewImage").src = "";
        selectedImageFile = null;
        
        renderCards();
        updateStorageInfo();
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯
        setTimeout(checkExpiringProducts, 1000);
        
        // Ø¹Ø±Ø¶ ØªÙ‚Ø±ÙŠØ± Ù…ÙØµÙ„
        let message = `${successfulImports} produits importÃ©s avec succÃ¨s!`;
        if (errors.length > 0) {
            message += `\n\nErreurs (${errors.length}):\n` + errors.slice(0, 5).join('\n');
            if (errors.length > 5) {
                message += `\n... et ${errors.length - 5} erreurs supplÃ©mentaires`;
            }
            console.log('Toutes les erreurs:', errors);
        }
        
        showCustomAlert("RAPPORT D'IMPORT", message);
    });
}

// ==== Ø¯Ø§Ù„Ø© Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù CSV ====
function loadCSVFile(file) {
    const reader = new FileReader();
    reader.onload = function(e) {
        const csvData = e.target.result;
        Papa.parse(csvData, {
            header: true,
            complete: function(results) {
                processImportData(results.data);
            },
            error: function(error) {
                console.error('Error parsing CSV:', error);
                showCustomAlert("ERREUR CSV", "Erreur lors de la lecture du fichier CSV");
            }
        });
    };
    reader.readAsText(file);
}

// ==== ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ§Ù„Ø­Ø°Ù Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ ====
// ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 2: Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ====
let currentEditingProductId = null;

// ==== Ø§Ù„ØªØµØ­ÙŠØ­: ØªØ¹Ø±ÙŠÙ Ø¯Ø§Ù„Ø© ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙÙŠ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ ====
window.openEditModal = function(product) {
    // ==== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ 2: Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ù…Ù†ØªØ¬ ÙƒØ§Ù…Ù„ ====
    currentEditingProductId = product.id;
    document.getElementById('editExpiry').value = product.expiry;
    document.getElementById('editQuantity').value = product.quantity;
    document.getElementById('editModal').style.display = 'flex';
};

document.getElementById('cancelEditButton').addEventListener('click', function() {
    document.getElementById('editModal').style.display = 'none';
    currentEditingProductId = null;
    currentEditingProduct = null;
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù†Øµ Ø²Ø± Ø§Ù„Ø­ÙØ¸
    document.getElementById('saveEditButton').textContent = 'ğŸ’¾ SAUVEGARDER';
});

// ==== Ø§Ù„ØªØµØ­ÙŠØ­: ØªØ¹Ø±ÙŠÙ Ø¯Ø§Ù„Ø© Ø§Ù„Ø­Ø°Ù Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ ÙÙŠ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ ====
window.deleteAllInSection = function(sectionProducts) {
    showCustomConfirm(sectionProducts.length, function() {
        const deletePromises = sectionProducts.map(product => deleteProductById(product.id));
        
        Promise.all(deletePromises).then(() => {
            products = products.filter(p => !sectionProducts.some(sp => sp.id === p.id));
            renderCards();
            updateStorageInfo();
            showSuccessMessage(`${sectionProducts.length} produits supprimÃ©s avec succÃ¨s!`);
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„Ø­Ø°Ù
            setTimeout(checkExpiringProducts, 1000);
            
            if (document.getElementById('searchPage').style.display !== 'none') {
                const dateSearch = document.getElementById('dateSearch').value;
                const monthSearch = document.getElementById('monthSearch').value;
                const codeSearch = document.getElementById('codeSearch').value;
                if (dateSearch || monthSearch || codeSearch) {
                    document.getElementById('performSearchButton').click();
                }
            }
        }).catch(error => {
            console.error('Error deleting products:', error);
            showCustomAlert("ERREUR", "Erreur lors de la suppression des produits");
        });
    });
};

// RENDER CARDS
function renderCards() {
    const container = document.getElementById("cardsContainer");
    container.innerHTML = "";
    
    const sortedProducts = [...products].sort((a,b) => {
        const [d1,m1,y1] = a.expiry.split("/").map(Number);
        const [d2,m2,y2] = b.expiry.split("/").map(Number);
        return new Date(y1,m1-1,d1) - new Date(y2,m2-1,d2);
    });
    
    const expiredProducts = [];
    const futureProducts = [];
    
    sortedProducts.forEach(p => {
        const remaining = daysLeft(p.expiry);
        if(remaining < 0) {
            expiredProducts.push(p);
        } else {
            futureProducts.push(p);
        }
    });
    
    if(expiredProducts.length > 0) {
        const sectionTitle = document.createElement("div");
        sectionTitle.className = "month-section expired-section";
        sectionTitle.innerHTML = `
            <span>PÃ‰RIMÃ‰ <span class="month-count">${expiredProducts.length}</span></span>
            <button class="section-delete-btn" onclick="deleteAllInSection(${JSON.stringify(expiredProducts).replace(/"/g, '&quot;')})">
                SUPPRIMER
            </button>
        `;
        container.appendChild(sectionTitle);
        
        expiredProducts.forEach(p => {
            const remaining = daysLeft(p.expiry);
            const color = daysColor(remaining);
            const card = document.createElement("div");
            card.className = "card";
            card.style.borderLeftColor = color;
            card.innerHTML = `
                <div class="card-image-container" onclick="openEditModal(${JSON.stringify(p).replace(/"/g, '&quot;')})">
                    ${p.img ? `<img src="${p.img}" alt="">` : ""}
                    <div class="edit-overlay">ğŸ“ MODIFIER</div>
                </div>
                <div class="card-content">
                    <div class="card-header">
                        <span class="days-left" style="background:${color}">- ${Math.abs(remaining)} JOURS</span>
                    </div>
                    <span class="card-code">${p.code}</span>
                    <div class="card-name">${p.name}</div>
                    <div class="card-details">
                        <span class="card-date" onclick="openEditModal(${JSON.stringify(p).replace(/"/g, '&quot;')})">DATE: ${p.expiry}</span>
                        <span class="card-quantity" onclick="openEditModal(${JSON.stringify(p).replace(/"/g, '&quot;')})">QUANTITÃ‰: ${p.quantity}</span>
                    </div>
                </div>
                <div class="card-footer">
                    <button class="edit-btn" onclick="openEditModal(${JSON.stringify(p).replace(/"/g, '&quot;')})">âœï¸</button>
                    <button class="delete-btn" onclick="deleteProduct(${p.id})">X</button>
                </div>
            `;
            container.appendChild(card);
        });
    }
    
    const productsByMonth = {};
    
    futureProducts.forEach(p => {
        const [d,m,y] = p.expiry.split("/").map(Number);
        const monthKey = `${m.toString().padStart(2, '0')}-${y}`;
        if(!productsByMonth[monthKey]) {
            productsByMonth[monthKey] = [];
        }
        productsByMonth[monthKey].push(p);
    });
    
    Object.keys(productsByMonth).sort((a,b) => {
        const [m1,y1] = a.split("-").map(Number);
        const [m2,y2] = b.split("-").map(Number);
        return new Date(y1, m1-1) - new Date(y2, m2-1);
    }).forEach(monthKey => {
        const sectionProducts = productsByMonth[monthKey];
        const sectionTitle = document.createElement("div");
        sectionTitle.className = "month-section future-section";
        sectionTitle.innerHTML = `
            <span>MOIS ${monthKey} <span class="month-count">${sectionProducts.length}</span></span>
            <button class="section-delete-btn" onclick="deleteAllInSection(${JSON.stringify(sectionProducts).replace(/"/g, '&quot;')})">
                SUPPRIMER
            </button>
        `;
        container.appendChild(sectionTitle);
        
        sectionProducts.forEach(p => {
            const remaining = daysLeft(p.expiry);
            const color = daysColor(remaining);
            const card = document.createElement("div");
            card.className = "card";
            card.style.borderLeftColor = color;
            card.innerHTML = `
                <div class="card-image-container" onclick="openEditModal(${JSON.stringify(p).replace(/"/g, '&quot;')})">
                    ${p.img ? `<img src="${p.img}" alt="">` : ""}
                    <div class="edit-overlay">ğŸ“ MODIFIER</div>
                </div>
                <div class="card-content">
                    <div class="card-header">
                        <span class="days-left" style="background:${color}">${remaining} JOURS RESTANT</span>
                </div>
                    <span class="card-code">${p.code}</span>
                    <div class="card-name">${p.name}</div>
                    <div class="card-details">
                        <span class="card-date" onclick="openEditModal(${JSON.stringify(p).replace(/"/g, '&quot;')})">DATE: ${p.expiry}</span>
                        <span class="card-quantity" onclick="openEditModal(${JSON.stringify(p).replace(/"/g, '&quot;')})">QUANTITÃ‰: ${p.quantity}</span>
                    </div>
                </div>
                <div class="card-footer">
                    <button class="edit-btn" onclick="openEditModal(${JSON.stringify(p).replace(/"/g, '&quot;')})">âœï¸</button>
                    <button class="delete-btn" onclick="deleteProduct(${p.id})">X</button>
                </div>
            `;
            container.appendChild(card);
        });
    });
    
    document.getElementById("productCountNumber").textContent = products.length;
}

// ==== INITIAL RENDER ====
initApp();
</script>
</body>
</html>