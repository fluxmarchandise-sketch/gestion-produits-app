<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Gestion Produits</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { font-family:sans-serif; background:#f5f7fa; margin:0; display:flex; flex-direction:column; align-items:center; }
h2 { margin:15px; }
.inputs-container { width:95%; display:flex; flex-wrap:wrap; gap:10px; margin-bottom:10px; }
input, button { padding:8px; font-size:14px; border-radius:6px; border:1px solid #ccc; }
button { cursor:pointer; color:#fff; border:none; }
#addButton { background:#3498db; } #importButton { background:#9b59b6; } #shareCSV { background:#2ecc71; }
.cards-container { width:95%; display:flex; flex-direction:column; gap:10px; }
.card { background:#fff; padding:8px; border-radius:6px; box-shadow:0 2px 6px rgba(0,0,0,0.1); display:flex; justify-content:space-between; }
.card-footer button { background:#e74c3c; width:25px; height:25px; border-radius:50%; }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
</head>
<body>

<h2>Gestion Produits</h2>
<div class="inputs-container">
    <input id="codeInput" placeholder="Code produit">
    <input id="nameOutput" placeholder="Nom produit">
    <input id="expiryInput" placeholder="Date (DD/MM/YYYY)">
    <input id="quantityInput" type="number" placeholder="Quantité">
    <button id="addButton">Ajouter</button>
    <button id="importButton">Importer CSV</button>
    <button id="shareCSV">Partager CSV</button>
</div>

<p id="productCount">Nombre de produits: 0</p>
<div class="cards-container" id="cardsContainer"></div>

<script>
let products = JSON.parse(localStorage.getItem("products")) || [];

// Ajouter produit
document.getElementById("addButton").addEventListener("click",()=>{
    const code = document.getElementById("codeInput").value.trim();
    const name = document.getElementById("nameOutput").value.trim();
    const expiry = document.getElementById("expiryInput").value.trim();
    const quantity = document.getElementById("quantityInput").value.trim();
    if(!code||!quantity){ alert("Remplissez tous les champs!"); return; }
    products.push({Code:code, Nom:name, Date:expiry, Quantité:quantity});
    localStorage.setItem("products",JSON.stringify(products));
    document.getElementById("codeInput").value=""; document.getElementById("nameOutput").value="";
    document.getElementById("expiryInput").value=""; document.getElementById("quantityInput").value="";
    renderCards();
});

// Import CSV
document.getElementById("importButton").addEventListener("click",()=>{
    const input = document.createElement("input"); input.type="file"; input.accept=".csv";
    input.onchange = e => {
        const file = e.target.files[0];
        Papa.parse(file,{header:true,complete:results=>{
            results.data.forEach(p=>{ if(p.Code) products.push(p); });
            localStorage.setItem("products",JSON.stringify(products));
            renderCards();
        }});
    }; input.click();
});

// Render Cards
function renderCards(){
    const container = document.getElementById("cardsContainer");
    container.innerHTML = "";
    products.forEach((p,i)=>{
        const card = document.createElement("div"); card.className="card";
        card.innerHTML = `<span>${p.Code} - ${p.Nom} (${p.Quantité})</span>
                          <div class="card-footer"><button onclick="deleteProduct(${i})">X</button></div>`;
        container.appendChild(card);
    });
    document.getElementById("productCount").textContent=`Nombre de produits: ${products.length}`;
}

// Supprimer produit
function deleteProduct(i){ products.splice(i,1); localStorage.setItem("products",JSON.stringify(products)); renderCards(); }

// Partager CSV (WebView friendly)
document.getElementById("shareCSV").addEventListener("click",()=>{
    if(products.length===0){ alert("Aucun produit à partager!"); return; }
    const csv = Papa.unparse(products);
    const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    // Si Web Share API متوفر
    if(navigator.share && navigator.canShare && navigator.canShare({files:[new File([blob],"produits.csv",{type:"text/csv"})]})){
        navigator.share({files:[new File([blob],"produits.csv",{type:"text/csv"})],title:"Produits"}).catch(e=>alert("Erreur partage: "+e));
    } else {
        const a = document.createElement("a"); a.href=url; a.download="produits.csv"; a.click(); URL.revokeObjectURL(url);
    }
});

renderCards();
</script>

</body>
</html>