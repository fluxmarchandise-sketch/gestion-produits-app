<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Gestion Produits</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {
    margin:0; font-family:'Segoe UI', Tahoma, Geneva, Verdana,sans-serif;
    background:#f5f7fa; color:#333; display:flex; flex-direction:column; align-items:center;
}
.inputs-container { width:95%; display:flex; flex-wrap:wrap; gap:10px; margin-bottom:10px; }
input, button { padding:10px; font-size:16px; border-radius:8px; border:1px solid #ccc; }
button { border:none; color:#fff; font-weight:bold; cursor:pointer; }
#addButton { background:#3498db; }
#importButton { background:#9b59b6; }
#downloadXLSX { background:#2ecc71; }
#shareButton { background:#e67e22; }
#scanButton { background:#e67e22; font-size:14px; padding:6px 10px; }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
</head>
<body>

<h2>Gestion Produits</h2>

<div class="inputs-container">
    <input id="codeInput" placeholder="Code produit" style="flex:1;">
    <input id="nameOutput" placeholder="Nom produit" readonly style="flex:1;">
    <input id="expiryInput" placeholder="Date (JJ/MM/AAAA)" style="flex:1;">
    <input id="quantityInput" type="number" placeholder="Quantité" style="flex:1;">

    <button id="addButton">Ajouter</button>
    <button id="importButton">Importer</button>
    <button id="downloadXLSX">Télécharger Excel</button>
    <button id="shareButton">Partager CSV</button>
</div>

<script>
let products = JSON.parse(localStorage.getItem("products")) || [];

// إضافة منتج
document.getElementById("addButton").addEventListener("click", function() {
    const code = document.getElementById("codeInput").value;
    const name = document.getElementById("nameOutput").value;
    const expiry = document.getElementById("expiryInput").value;
    const quantity = document.getElementById("quantityInput").value;
    
    if(code && name && expiry && quantity) {
        products.push({code, name, expiry, quantity});
        localStorage.setItem("products", JSON.stringify(products));
        alert("Produit ajouté!");
    }
});

// زر المشاركة - يشارك ملف CSV مباشرة
document.getElementById("shareButton").addEventListener("click", function() {
    if (products.length === 0) {
        alert("Aucun produit à partager!");
        return;
    }

    // إنشاء محتوى CSV
    const headers = ["Code", "Nom", "Date", "Quantité"];
    const csvLines = products.map(p => [p.code, p.name, p.expiry, p.quantity]);
    
    const csvContent = [headers, ...csvLines]
        .map(row => row.join(","))
        .join("\n");

    // إنشاء ملف CSV
    const blob = new Blob([csvContent], { type: "text/csv" });
    const file = new File([blob], "produits.csv", { type: "text/csv" });

    // محاولة المشاركة المباشرة
    if (navigator.share) {
        navigator.share({
            files: [file],
            title: 'Liste des produits',
            text: `Liste de ${products.length} produits`
        }).catch(error => {
            console.log("Partage direct échoué:", error);
            downloadCSV(blob);
        });
    } else {
        // إذا لم يدعم المتصفح المشاركة المباشرة
        downloadCSV(blob);
    }
});

// دالة لتحميل CSV كبديل
function downloadCSV(blob) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "produits.csv";
    a.click();
    URL.revokeObjectURL(url);
}

// باقي الدوال الأساسية...
document.getElementById("downloadXLSX").addEventListener("click", function() {
    if (products.length === 0) return;
    
    const ws = XLSX.utils.json_to_sheet(products);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Produits");
    XLSX.writeFile(wb, "produits.xlsx");
});
</script>
</body>
</html>